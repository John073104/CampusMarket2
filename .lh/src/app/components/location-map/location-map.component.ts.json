{
    "sourceFile": "src/app/components/location-map/location-map.component.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1763640468897,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1763640468897,
            "name": "Commit-0",
            "content": "import { Component, OnInit, AfterViewInit, Input, Output, EventEmitter, OnDestroy } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { IonicModule } from '@ionic/angular';\r\nimport * as L from 'leaflet';\r\n\r\n@Component({\r\n  selector: 'app-location-map',\r\n  templateUrl: './location-map.component.html',\r\n  styleUrls: ['./location-map.component.scss'],\r\n  standalone: true,\r\n  imports: [CommonModule, IonicModule]\r\n})\r\nexport class LocationMapComponent implements OnInit, AfterViewInit, OnDestroy {\r\n  @Input() latitude: number = 14.5995; // Default: Manila, Philippines\r\n  @Input() longitude: number = 120.9842;\r\n  @Input() editable: boolean = false; // Can user pick location?\r\n  @Input() height: string = '400px';\r\n  @Output() locationSelected = new EventEmitter<{ latitude: number; longitude: number; address?: string }>();\r\n\r\n  private map: L.Map | null = null;\r\n  private marker: L.Marker | null = null;\r\n\r\n  constructor() {}\r\n\r\n  ngOnInit() {}\r\n\r\n  ngAfterViewInit() {\r\n    setTimeout(() => {\r\n      this.initializeMap();\r\n    }, 100);\r\n  }\r\n\r\n  private initializeMap() {\r\n    // Fix Leaflet icon issue\r\n    const iconRetinaUrl = 'assets/marker-icon-2x.png';\r\n    const iconUrl = 'assets/marker-icon.png';\r\n    const shadowUrl = 'assets/marker-shadow.png';\r\n    const iconDefault = L.icon({\r\n      iconRetinaUrl,\r\n      iconUrl,\r\n      shadowUrl,\r\n      iconSize: [25, 41],\r\n      iconAnchor: [12, 41],\r\n      popupAnchor: [1, -34],\r\n      tooltipAnchor: [16, -28],\r\n      shadowSize: [41, 41]\r\n    });\r\n    L.Marker.prototype.options.icon = iconDefault;\r\n\r\n    // Create map\r\n    this.map = L.map('map').setView([this.latitude, this.longitude], 13);\r\n\r\n    // Add OpenStreetMap tile layer\r\n    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\r\n      attribution: 'Â© OpenStreetMap contributors',\r\n      maxZoom: 19\r\n    }).addTo(this.map);\r\n\r\n    // Add marker\r\n    this.marker = L.marker([this.latitude, this.longitude], {\r\n      draggable: this.editable\r\n    }).addTo(this.map);\r\n\r\n    if (this.editable) {\r\n      // Allow clicking on map to set location\r\n      this.map.on('click', (e: L.LeafletMouseEvent) => {\r\n        this.updateMarkerPosition(e.latlng);\r\n      });\r\n\r\n      // Handle marker drag\r\n      this.marker.on('dragend', () => {\r\n        const position = this.marker!.getLatLng();\r\n        this.updateMarkerPosition(position);\r\n      });\r\n    }\r\n\r\n    // Get initial address\r\n    this.getAddressFromCoordinates(this.latitude, this.longitude);\r\n  }\r\n\r\n  private updateMarkerPosition(latlng: L.LatLng) {\r\n    if (this.marker) {\r\n      this.marker.setLatLng(latlng);\r\n      this.map?.panTo(latlng);\r\n      \r\n      const lat = latlng.lat;\r\n      const lng = latlng.lng;\r\n      \r\n      this.getAddressFromCoordinates(lat, lng);\r\n      this.locationSelected.emit({ latitude: lat, longitude: lng });\r\n    }\r\n  }\r\n\r\n  private async getAddressFromCoordinates(lat: number, lng: number) {\r\n    try {\r\n      // Using Nominatim (OpenStreetMap's geocoding service)\r\n      const response = await fetch(\r\n        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`\r\n      );\r\n      const data = await response.json();\r\n      \r\n      if (data.display_name) {\r\n        const address = data.display_name;\r\n        this.locationSelected.emit({ latitude: lat, longitude: lng, address });\r\n        \r\n        if (this.marker) {\r\n          this.marker.bindPopup(address).openPopup();\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('Error getting address:', error);\r\n    }\r\n  }\r\n\r\n  getCurrentLocation() {\r\n    if (navigator.geolocation) {\r\n      navigator.geolocation.getCurrentPosition(\r\n        (position) => {\r\n          const lat = position.coords.latitude;\r\n          const lng = position.coords.longitude;\r\n          \r\n          if (this.map && this.marker) {\r\n            this.marker.setLatLng([lat, lng]);\r\n            this.map.setView([lat, lng], 15);\r\n            this.getAddressFromCoordinates(lat, lng);\r\n          }\r\n        },\r\n        (error) => {\r\n          console.error('Error getting location:', error);\r\n          alert('Unable to get your location. Please select manually on the map.');\r\n        }\r\n      );\r\n    } else {\r\n      alert('Geolocation is not supported by your browser.');\r\n    }\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    if (this.map) {\r\n      this.map.remove();\r\n      this.map = null;\r\n    }\r\n  }\r\n}\r\n"
        }
    ]
}