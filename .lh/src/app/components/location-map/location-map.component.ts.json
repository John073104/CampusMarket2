{
    "sourceFile": "src/app/components/location-map/location-map.component.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 4,
            "patches": [
                {
                    "date": 1763640468897,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1764595290835,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -10,10 +10,10 @@\n   standalone: true,\r\n   imports: [CommonModule, IonicModule]\r\n })\r\n export class LocationMapComponent implements OnInit, AfterViewInit, OnDestroy {\r\n-  @Input() latitude: number = 14.5995; // Default: Manila, Philippines\r\n-  @Input() longitude: number = 120.9842;\r\n+  @Input() latitude: number = 13.1023; // Default: Calapan City, Oriental Mindoro\r\n+  @Input() longitude: number = 121.1801;\r\n   @Input() editable: boolean = false; // Can user pick location?\r\n   @Input() height: string = '400px';\r\n   @Output() locationSelected = new EventEmitter<{ latitude: number; longitude: number; address?: string }>();\r\n \r\n@@ -46,15 +46,23 @@\n       shadowSize: [41, 41]\r\n     });\r\n     L.Marker.prototype.options.icon = iconDefault;\r\n \r\n-    // Create map\r\n-    this.map = L.map('map').setView([this.latitude, this.longitude], 13);\r\n+    // Create map centered on Oriental Mindoro, Philippines\r\n+    this.map = L.map('map', {\r\n+      minZoom: 6,  // Prevent zooming out too far\r\n+      maxBounds: [  // Restrict map to Philippines bounds\r\n+        [4.5, 116.0],   // Southwest corner (southernmost Philippines)\r\n+        [21.0, 127.0]   // Northeast corner (northernmost Philippines)\r\n+      ],\r\n+      maxBoundsViscosity: 1.0  // Make bounds solid\r\n+    }).setView([this.latitude, this.longitude], 13);\r\n \r\n     // Add OpenStreetMap tile layer\r\n     L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\r\n       attribution: '© OpenStreetMap contributors',\r\n-      maxZoom: 19\r\n+      maxZoom: 19,\r\n+      minZoom: 6\r\n     }).addTo(this.map);\r\n \r\n     // Add marker\r\n     this.marker = L.marker([this.latitude, this.longitude], {\r\n"
                },
                {
                    "date": 1764595425038,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -10,10 +10,10 @@\n   standalone: true,\r\n   imports: [CommonModule, IonicModule]\r\n })\r\n export class LocationMapComponent implements OnInit, AfterViewInit, OnDestroy {\r\n-  @Input() latitude: number = 13.1023; // Default: Calapan City, Oriental Mindoro\r\n-  @Input() longitude: number = 121.1801;\r\n+  @Input() latitude: number = 13.1640; // Default: Victoria, Alcate, Oriental Mindoro\r\n+  @Input() longitude: number = 121.3279;\r\n   @Input() editable: boolean = false; // Can user pick location?\r\n   @Input() height: string = '400px';\r\n   @Output() locationSelected = new EventEmitter<{ latitude: number; longitude: number; address?: string }>();\r\n \r\n"
                },
                {
                    "date": 1764596988459,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -69,8 +69,11 @@\n       draggable: this.editable\r\n     }).addTo(this.map);\r\n \r\n     if (this.editable) {\r\n+      // Automatically get current location when editable\r\n+      this.getCurrentLocation();\r\n+\r\n       // Allow clicking on map to set location\r\n       this.map.on('click', (e: L.LeafletMouseEvent) => {\r\n         this.updateMarkerPosition(e.latlng);\r\n       });\r\n@@ -79,12 +82,12 @@\n       this.marker.on('dragend', () => {\r\n         const position = this.marker!.getLatLng();\r\n         this.updateMarkerPosition(position);\r\n       });\r\n+    } else {\r\n+      // Get initial address for non-editable mode\r\n+      this.getAddressFromCoordinates(this.latitude, this.longitude);\r\n     }\r\n-\r\n-    // Get initial address\r\n-    this.getAddressFromCoordinates(this.latitude, this.longitude);\r\n   }\r\n \r\n   private updateMarkerPosition(latlng: L.LatLng) {\r\n     if (this.marker) {\r\n@@ -100,15 +103,45 @@\n   }\r\n \r\n   private async getAddressFromCoordinates(lat: number, lng: number) {\r\n     try {\r\n-      // Using Nominatim (OpenStreetMap's geocoding service)\r\n+      // Using Nominatim (OpenStreetMap's geocoding service) with higher zoom for accuracy\r\n       const response = await fetch(\r\n-        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`\r\n+        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=19&addressdetails=1&accept-language=en`\r\n       );\r\n       const data = await response.json();\r\n       \r\n-      if (data.display_name) {\r\n+      if (data.address) {\r\n+        // Build more accurate address from components\r\n+        const addressParts = [];\r\n+        \r\n+        // Add specific location details first\r\n+        if (data.address.road) addressParts.push(data.address.road);\r\n+        if (data.address.village) addressParts.push(data.address.village);\r\n+        if (data.address.suburb) addressParts.push(data.address.suburb);\r\n+        if (data.address.hamlet) addressParts.push(data.address.hamlet);\r\n+        \r\n+        // Add municipality/town\r\n+        if (data.address.municipality) addressParts.push(data.address.municipality);\r\n+        if (data.address.town) addressParts.push(data.address.town);\r\n+        if (data.address.city) addressParts.push(data.address.city);\r\n+        \r\n+        // Add province\r\n+        if (data.address.state) addressParts.push(data.address.state);\r\n+        if (data.address.province) addressParts.push(data.address.province);\r\n+        \r\n+        const address = addressParts.length > 0 ? addressParts.join(', ') : data.display_name;\r\n+        \r\n+        this.locationSelected.emit({ latitude: lat, longitude: lng, address });\r\n+        \r\n+        if (this.marker) {\r\n+          this.marker.bindPopup(`\r\n+            <strong>Coordinates:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}<br>\r\n+            <strong>Address:</strong> ${address}\r\n+          `).openPopup();\r\n+        }\r\n+      } else if (data.display_name) {\r\n+        // Fallback to display name\r\n         const address = data.display_name;\r\n         this.locationSelected.emit({ latitude: lat, longitude: lng, address });\r\n         \r\n         if (this.marker) {\r\n@@ -116,8 +149,14 @@\n         }\r\n       }\r\n     } catch (error) {\r\n       console.error('Error getting address:', error);\r\n+      // Emit coordinates anyway so user can save location\r\n+      this.locationSelected.emit({ \r\n+        latitude: lat, \r\n+        longitude: lng, \r\n+        address: `Coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)}` \r\n+      });\r\n     }\r\n   }\r\n \r\n   getCurrentLocation() {\r\n"
                },
                {
                    "date": 1764597204105,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -63,31 +63,15 @@\n       maxZoom: 19,\r\n       minZoom: 6\r\n     }).addTo(this.map);\r\n \r\n-    // Add marker\r\n+    // Add marker - NEVER draggable, always fixed to GPS position\r\n     this.marker = L.marker([this.latitude, this.longitude], {\r\n-      draggable: this.editable\r\n+      draggable: false  // Always false - marker cannot be moved manually\r\n     }).addTo(this.map);\r\n \r\n-    if (this.editable) {\r\n-      // Automatically get current location when editable\r\n-      this.getCurrentLocation();\r\n-\r\n-      // Allow clicking on map to set location\r\n-      this.map.on('click', (e: L.LeafletMouseEvent) => {\r\n-        this.updateMarkerPosition(e.latlng);\r\n-      });\r\n-\r\n-      // Handle marker drag\r\n-      this.marker.on('dragend', () => {\r\n-        const position = this.marker!.getLatLng();\r\n-        this.updateMarkerPosition(position);\r\n-      });\r\n-    } else {\r\n-      // Get initial address for non-editable mode\r\n-      this.getAddressFromCoordinates(this.latitude, this.longitude);\r\n-    }\r\n+    // Always get real GPS location automatically\r\n+    this.getCurrentLocation();\r\n   }\r\n \r\n   private updateMarkerPosition(latlng: L.LatLng) {\r\n     if (this.marker) {\r\n"
                }
            ],
            "date": 1763640468897,
            "name": "Commit-0",
            "content": "import { Component, OnInit, AfterViewInit, Input, Output, EventEmitter, OnDestroy } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { IonicModule } from '@ionic/angular';\r\nimport * as L from 'leaflet';\r\n\r\n@Component({\r\n  selector: 'app-location-map',\r\n  templateUrl: './location-map.component.html',\r\n  styleUrls: ['./location-map.component.scss'],\r\n  standalone: true,\r\n  imports: [CommonModule, IonicModule]\r\n})\r\nexport class LocationMapComponent implements OnInit, AfterViewInit, OnDestroy {\r\n  @Input() latitude: number = 14.5995; // Default: Manila, Philippines\r\n  @Input() longitude: number = 120.9842;\r\n  @Input() editable: boolean = false; // Can user pick location?\r\n  @Input() height: string = '400px';\r\n  @Output() locationSelected = new EventEmitter<{ latitude: number; longitude: number; address?: string }>();\r\n\r\n  private map: L.Map | null = null;\r\n  private marker: L.Marker | null = null;\r\n\r\n  constructor() {}\r\n\r\n  ngOnInit() {}\r\n\r\n  ngAfterViewInit() {\r\n    setTimeout(() => {\r\n      this.initializeMap();\r\n    }, 100);\r\n  }\r\n\r\n  private initializeMap() {\r\n    // Fix Leaflet icon issue\r\n    const iconRetinaUrl = 'assets/marker-icon-2x.png';\r\n    const iconUrl = 'assets/marker-icon.png';\r\n    const shadowUrl = 'assets/marker-shadow.png';\r\n    const iconDefault = L.icon({\r\n      iconRetinaUrl,\r\n      iconUrl,\r\n      shadowUrl,\r\n      iconSize: [25, 41],\r\n      iconAnchor: [12, 41],\r\n      popupAnchor: [1, -34],\r\n      tooltipAnchor: [16, -28],\r\n      shadowSize: [41, 41]\r\n    });\r\n    L.Marker.prototype.options.icon = iconDefault;\r\n\r\n    // Create map\r\n    this.map = L.map('map').setView([this.latitude, this.longitude], 13);\r\n\r\n    // Add OpenStreetMap tile layer\r\n    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\r\n      attribution: '© OpenStreetMap contributors',\r\n      maxZoom: 19\r\n    }).addTo(this.map);\r\n\r\n    // Add marker\r\n    this.marker = L.marker([this.latitude, this.longitude], {\r\n      draggable: this.editable\r\n    }).addTo(this.map);\r\n\r\n    if (this.editable) {\r\n      // Allow clicking on map to set location\r\n      this.map.on('click', (e: L.LeafletMouseEvent) => {\r\n        this.updateMarkerPosition(e.latlng);\r\n      });\r\n\r\n      // Handle marker drag\r\n      this.marker.on('dragend', () => {\r\n        const position = this.marker!.getLatLng();\r\n        this.updateMarkerPosition(position);\r\n      });\r\n    }\r\n\r\n    // Get initial address\r\n    this.getAddressFromCoordinates(this.latitude, this.longitude);\r\n  }\r\n\r\n  private updateMarkerPosition(latlng: L.LatLng) {\r\n    if (this.marker) {\r\n      this.marker.setLatLng(latlng);\r\n      this.map?.panTo(latlng);\r\n      \r\n      const lat = latlng.lat;\r\n      const lng = latlng.lng;\r\n      \r\n      this.getAddressFromCoordinates(lat, lng);\r\n      this.locationSelected.emit({ latitude: lat, longitude: lng });\r\n    }\r\n  }\r\n\r\n  private async getAddressFromCoordinates(lat: number, lng: number) {\r\n    try {\r\n      // Using Nominatim (OpenStreetMap's geocoding service)\r\n      const response = await fetch(\r\n        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`\r\n      );\r\n      const data = await response.json();\r\n      \r\n      if (data.display_name) {\r\n        const address = data.display_name;\r\n        this.locationSelected.emit({ latitude: lat, longitude: lng, address });\r\n        \r\n        if (this.marker) {\r\n          this.marker.bindPopup(address).openPopup();\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('Error getting address:', error);\r\n    }\r\n  }\r\n\r\n  getCurrentLocation() {\r\n    if (navigator.geolocation) {\r\n      navigator.geolocation.getCurrentPosition(\r\n        (position) => {\r\n          const lat = position.coords.latitude;\r\n          const lng = position.coords.longitude;\r\n          \r\n          if (this.map && this.marker) {\r\n            this.marker.setLatLng([lat, lng]);\r\n            this.map.setView([lat, lng], 15);\r\n            this.getAddressFromCoordinates(lat, lng);\r\n          }\r\n        },\r\n        (error) => {\r\n          console.error('Error getting location:', error);\r\n          alert('Unable to get your location. Please select manually on the map.');\r\n        }\r\n      );\r\n    } else {\r\n      alert('Geolocation is not supported by your browser.');\r\n    }\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    if (this.map) {\r\n      this.map.remove();\r\n      this.map = null;\r\n    }\r\n  }\r\n}\r\n"
        }
    ]
}