{
    "sourceFile": "src/app/services/auth.service.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1763385225714,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763888577875,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -190,8 +190,24 @@\n   getCurrentUser(): User | null {\r\n     return this.currentUserSubject.value;\r\n   }\r\n \r\n+  async refreshCurrentUser(): Promise<void> {\r\n+    const currentUser = this.currentUserSubject.value;\r\n+    if (currentUser && currentUser.userId) {\r\n+      try {\r\n+        const userDoc = await getDoc(doc(this.firestore, 'users', currentUser.userId));\r\n+        if (userDoc.exists()) {\r\n+          const userData = userDoc.data() as User;\r\n+          this.currentUserSubject.next(userData);\r\n+          localStorage.setItem('currentUser', JSON.stringify(userData));\r\n+        }\r\n+      } catch (error) {\r\n+        console.error('Error refreshing user:', error);\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n   isAuthenticated(): boolean {\r\n     return this.currentUserSubject.value !== null;\r\n   }\r\n \r\n"
                },
                {
                    "date": 1764141446066,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -34,14 +34,31 @@\n     this.initAuthListener();\r\n   }\r\n \r\n   private initAuthListener() {\r\n+    // Check localStorage first for immediate user state\r\n+    const storedUser = localStorage.getItem('currentUser');\r\n+    if (storedUser) {\r\n+      try {\r\n+        const userData = JSON.parse(storedUser);\r\n+        this.currentUserSubject.next(userData);\r\n+      } catch (error) {\r\n+        console.error('Error parsing stored user:', error);\r\n+        localStorage.removeItem('currentUser');\r\n+      }\r\n+    }\r\n+\r\n+    // Then listen for auth state changes\r\n     onAuthStateChanged(this.auth, async (firebaseUser) => {\r\n       if (firebaseUser) {\r\n         const userData = await this.getUserData(firebaseUser.uid);\r\n         this.currentUserSubject.next(userData);\r\n+        if (userData) {\r\n+          localStorage.setItem('currentUser', JSON.stringify(userData));\r\n+        }\r\n       } else {\r\n         this.currentUserSubject.next(null);\r\n+        localStorage.removeItem('currentUser');\r\n       }\r\n     });\r\n   }\r\n \r\n@@ -126,8 +143,9 @@\n         throw new Error('User profile not found. Please contact support.');\r\n       }\r\n       \r\n       this.currentUserSubject.next(userData);\r\n+      localStorage.setItem('currentUser', JSON.stringify(userData));\r\n       \r\n       await this.redirectByRole(userData.role);\r\n     } catch (error: any) {\r\n       console.error('Login error details:', {\r\n@@ -162,8 +180,9 @@\n \r\n   async signOut(): Promise<void> {\r\n     await signOut(this.auth);\r\n     this.currentUserSubject.next(null);\r\n+    localStorage.removeItem('currentUser');\r\n     this.router.navigate(['/landing']);\r\n   }\r\n \r\n   private async getUserData(userId: string): Promise<User | null> {\r\n"
                }
            ],
            "date": 1763385225714,
            "name": "Commit-0",
            "content": "import { Injectable } from '@angular/core';\r\nimport { \r\n  Auth, \r\n  signInWithEmailAndPassword, \r\n  createUserWithEmailAndPassword,\r\n  signOut,\r\n  onAuthStateChanged,\r\n  sendPasswordResetEmail,\r\n  User as FirebaseUser\r\n} from '@angular/fire/auth';\r\nimport { \r\n  Firestore, \r\n  doc, \r\n  setDoc, \r\n  getDoc,\r\n  serverTimestamp \r\n} from '@angular/fire/firestore';\r\nimport { Router } from '@angular/router';\r\nimport { BehaviorSubject, Observable } from 'rxjs';\r\nimport { User } from '../models/user.model';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class AuthService {\r\n  private currentUserSubject = new BehaviorSubject<User | null>(null);\r\n  public currentUser$: Observable<User | null> = this.currentUserSubject.asObservable();\r\n\r\n  constructor(\r\n    private auth: Auth,\r\n    private firestore: Firestore,\r\n    private router: Router\r\n  ) {\r\n    this.initAuthListener();\r\n  }\r\n\r\n  private initAuthListener() {\r\n    onAuthStateChanged(this.auth, async (firebaseUser) => {\r\n      if (firebaseUser) {\r\n        const userData = await this.getUserData(firebaseUser.uid);\r\n        this.currentUserSubject.next(userData);\r\n      } else {\r\n        this.currentUserSubject.next(null);\r\n      }\r\n    });\r\n  }\r\n\r\n  async signUp(email: string, password: string, name: string): Promise<void> {\r\n    try {\r\n      console.log('Attempting signup for:', email);\r\n      console.log('Firebase Auth available:', !!this.auth);\r\n      \r\n      const userCredential = await createUserWithEmailAndPassword(\r\n        this.auth, \r\n        email, \r\n        password\r\n      );\r\n      \r\n      console.log('User created in Firebase Auth:', userCredential.user.uid);\r\n      \r\n      // Create user document in Firestore\r\n      const userData: User = {\r\n        userId: userCredential.user.uid,\r\n        email: email,\r\n        role: 'customer', // Default role\r\n        name: name,\r\n        dateJoined: serverTimestamp(),\r\n        isActive: true\r\n      };\r\n\r\n      await setDoc(\r\n        doc(this.firestore, 'users', userCredential.user.uid), \r\n        userData\r\n      );\r\n\r\n      console.log('User document created in Firestore successfully');\r\n      \r\n      // Sign out immediately after signup to redirect to login\r\n      await signOut(this.auth);\r\n      this.currentUserSubject.next(null);\r\n      // Don't auto-redirect, let the signup page handle it\r\n    } catch (error: any) {\r\n      console.error('Signup error details:', {\r\n        code: error.code,\r\n        message: error.message,\r\n        stack: error.stack\r\n      });\r\n      \r\n      // Provide user-friendly error messages\r\n      switch (error.code) {\r\n        case 'auth/configuration-not-found':\r\n          throw new Error('Firebase Authentication is not enabled. Please enable Email/Password sign-in in Firebase Console.');\r\n        case 'auth/network-request-failed':\r\n          throw new Error('Network error. Please check your internet connection and try again.');\r\n        case 'auth/email-already-in-use':\r\n          throw new Error('This email is already registered. Please login instead.');\r\n        case 'auth/invalid-email':\r\n          throw new Error('Invalid email format.');\r\n        case 'auth/weak-password':\r\n          throw new Error('Password is too weak. Use at least 6 characters.');\r\n        case 'auth/operation-not-allowed':\r\n          throw new Error('Email/Password sign-in is not enabled. Please contact administrator.');\r\n        default:\r\n          throw new Error(error.message || 'Signup failed. Please try again.');\r\n      }\r\n    }\r\n  }\r\n\r\n  async signIn(email: string, password: string): Promise<void> {\r\n    try {\r\n      console.log('Attempting login for:', email);\r\n      console.log('Firebase Auth state:', this.auth.currentUser ? 'Active' : 'Not initialized');\r\n      \r\n      const userCredential = await signInWithEmailAndPassword(\r\n        this.auth, \r\n        email, \r\n        password\r\n      );\r\n      \r\n      console.log('User signed in successfully:', userCredential.user.uid);\r\n      const userData = await this.getUserData(userCredential.user.uid);\r\n      console.log('User data retrieved:', userData);\r\n      \r\n      if (!userData) {\r\n        console.error('User data not found in Firestore for:', userCredential.user.uid);\r\n        throw new Error('User profile not found. Please contact support.');\r\n      }\r\n      \r\n      this.currentUserSubject.next(userData);\r\n      \r\n      await this.redirectByRole(userData.role);\r\n    } catch (error: any) {\r\n      console.error('Login error details:', {\r\n        code: error.code,\r\n        message: error.message,\r\n        stack: error.stack\r\n      });\r\n      \r\n      // Provide user-friendly error messages\r\n      switch (error.code) {\r\n        case 'auth/configuration-not-found':\r\n          throw new Error('Firebase Authentication is not enabled. Please enable Email/Password sign-in in Firebase Console.');\r\n        case 'auth/network-request-failed':\r\n          throw new Error('Network error. Please check your internet connection and try again.');\r\n        case 'auth/too-many-requests':\r\n          throw new Error('Too many failed attempts. Please try again later.');\r\n        case 'auth/user-not-found':\r\n          throw new Error('No account found with this email.');\r\n        case 'auth/wrong-password':\r\n          throw new Error('Incorrect password. Please try again.');\r\n        case 'auth/invalid-email':\r\n          throw new Error('Invalid email format.');\r\n        case 'auth/user-disabled':\r\n          throw new Error('This account has been disabled.');\r\n        case 'auth/invalid-credential':\r\n          throw new Error('Invalid email or password.');\r\n        default:\r\n          throw new Error(error.message || 'Login failed. Please try again.');\r\n      }\r\n    }\r\n  }\r\n\r\n  async signOut(): Promise<void> {\r\n    await signOut(this.auth);\r\n    this.currentUserSubject.next(null);\r\n    this.router.navigate(['/landing']);\r\n  }\r\n\r\n  private async getUserData(userId: string): Promise<User | null> {\r\n    const userDoc = await getDoc(doc(this.firestore, 'users', userId));\r\n    return userDoc.exists() ? userDoc.data() as User : null;\r\n  }\r\n\r\n  private async redirectByRole(role: string): Promise<void> {\r\n    switch (role) {\r\n      case 'customer':\r\n        this.router.navigate(['/customer']);\r\n        break;\r\n      case 'seller':\r\n        this.router.navigate(['/seller']);\r\n        break;\r\n      case 'admin':\r\n        this.router.navigate(['/admin']);\r\n        break;\r\n      default:\r\n        this.router.navigate(['/landing']);\r\n    }\r\n  }\r\n\r\n  getCurrentUser(): User | null {\r\n    return this.currentUserSubject.value;\r\n  }\r\n\r\n  isAuthenticated(): boolean {\r\n    return this.currentUserSubject.value !== null;\r\n  }\r\n\r\n  async resetPassword(email: string): Promise<void> {\r\n    try {\r\n      await sendPasswordResetEmail(this.auth, email);\r\n    } catch (error: any) {\r\n      console.error('Password reset error:', error.code, error.message);\r\n      throw error;\r\n    }\r\n  }\r\n}"
        }
    ]
}