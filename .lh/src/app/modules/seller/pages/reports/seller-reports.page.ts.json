{
    "sourceFile": "src/app/modules/seller/pages/reports/seller-reports.page.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1763388132037,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763389076610,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -89,9 +89,9 @@\n         .filter(o => o.status === 'completed')\r\n         .reduce((sum, order) => sum + (order.totalPrice || 0), 0);\r\n \r\n       this.stats.completedOrders = orders.filter(o => o.status === 'completed').length;\r\n-      this.stats.pendingOrders = orders.filter(o => o.status === 'pending').length;\r\n+      this.stats.pendingOrders = orders.filter(o => o.status === 'placed').length;\r\n       this.stats.cancelledOrders = orders.filter(o => o.status === 'cancelled').length;\r\n     } catch (error) {\r\n       console.error('Error loading stats:', error);\r\n     }\r\n@@ -203,16 +203,17 @@\n     try {\r\n       const orders = await this.orderService.getOrdersBySeller(this.sellerId);\r\n       \r\n       const statusCount = {\r\n-        pending: 0,\r\n+        placed: 0,\r\n         confirmed: 0,\r\n+        ready_for_pickup: 0,\r\n         completed: 0,\r\n         cancelled: 0\r\n       };\r\n \r\n       orders.forEach(order => {\r\n-        const status = order.status || 'pending';\r\n+        const status = order.status || 'placed';\r\n         if (status in statusCount) {\r\n           (statusCount as any)[status]++;\r\n         }\r\n       });\r\n@@ -224,17 +225,18 @@\n           const ctx = this.statusChartRef.nativeElement.getContext('2d');\r\n           this.statusChart = new Chart(ctx, {\r\n             type: 'doughnut',\r\n             data: {\r\n-              labels: ['Pending', 'Confirmed', 'Completed', 'Cancelled'],\r\n+              labels: ['Placed', 'Confirmed', 'Ready for Pickup', 'Completed', 'Cancelled'],\r\n               datasets: [{\r\n                 data: [\r\n-                  statusCount.pending,\r\n+                  statusCount.placed,\r\n                   statusCount.confirmed,\r\n+                  statusCount.ready_for_pickup,\r\n                   statusCount.completed,\r\n                   statusCount.cancelled\r\n                 ],\r\n-                backgroundColor: ['#ff9800', '#2196f3', '#4caf50', '#f44336']\r\n+                backgroundColor: ['#ff9800', '#2196f3', '#9c27b0', '#4caf50', '#f44336']\r\n               }]\r\n             },\r\n             options: {\r\n               responsive: true,\r\n"
                }
            ],
            "date": 1763388132037,
            "name": "Commit-0",
            "content": "import { Component, OnInit, ViewChild, ElementRef } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\nimport { IonicModule, ToastController } from '@ionic/angular';\r\nimport { OrderService } from 'src/app/services/order.service';\r\nimport { ProductService } from 'src/app/services/product.service';\r\nimport { AuthService } from 'src/app/services/auth.service';\r\nimport { Chart, registerables } from 'chart.js';\r\nimport jsPDF from 'jspdf';\r\nimport html2canvas from 'html2canvas';\r\n\r\nChart.register(...registerables);\r\n\r\n@Component({\r\n  selector: 'app-seller-reports',\r\n  templateUrl: './seller-reports.page.html',\r\n  styleUrls: ['./seller-reports.page.scss'],\r\n  standalone: true,\r\n  imports: [CommonModule, FormsModule, IonicModule]\r\n})\r\nexport class SellerReportsPage implements OnInit {\r\n  @ViewChild('salesChart') salesChartRef!: ElementRef;\r\n  @ViewChild('productChart') productChartRef!: ElementRef;\r\n  @ViewChild('statusChart') statusChartRef!: ElementRef;\r\n  @ViewChild('reportContent') reportContent!: ElementRef;\r\n\r\n  salesChart: Chart | null = null;\r\n  productChart: Chart | null = null;\r\n  statusChart: Chart | null = null;\r\n\r\n  loading = false;\r\n  sellerId = '';\r\n\r\n  stats = {\r\n    totalSales: 0,\r\n    totalOrders: 0,\r\n    totalProducts: 0,\r\n    completedOrders: 0,\r\n    pendingOrders: 0,\r\n    cancelledOrders: 0\r\n  };\r\n\r\n  constructor(\r\n    private orderService: OrderService,\r\n    private productService: ProductService,\r\n    private authService: AuthService,\r\n    private toastController: ToastController\r\n  ) {}\r\n\r\n  async ngOnInit() {\r\n    const user = this.authService.getCurrentUser();\r\n    if (user) {\r\n      this.sellerId = user.userId!;\r\n      await this.loadReports();\r\n    }\r\n  }\r\n\r\n  async loadReports() {\r\n    this.loading = true;\r\n    try {\r\n      await Promise.all([\r\n        this.loadStats(),\r\n        this.loadSalesChart(),\r\n        this.loadProductChart(),\r\n        this.loadStatusChart()\r\n      ]);\r\n    } catch (error) {\r\n      console.error('Error loading reports:', error);\r\n      const toast = await this.toastController.create({\r\n        message: 'Failed to load reports',\r\n        duration: 3000,\r\n        color: 'danger'\r\n      });\r\n      await toast.present();\r\n    } finally {\r\n      this.loading = false;\r\n    }\r\n  }\r\n\r\n  async loadStats() {\r\n    try {\r\n      const orders = await this.orderService.getOrdersBySeller(this.sellerId);\r\n      const products = await this.productService.getProductsBySeller(this.sellerId);\r\n\r\n      this.stats.totalOrders = orders.length;\r\n      this.stats.totalProducts = products.length;\r\n\r\n      this.stats.totalSales = orders\r\n        .filter(o => o.status === 'completed')\r\n        .reduce((sum, order) => sum + (order.totalPrice || 0), 0);\r\n\r\n      this.stats.completedOrders = orders.filter(o => o.status === 'completed').length;\r\n      this.stats.pendingOrders = orders.filter(o => o.status === 'pending').length;\r\n      this.stats.cancelledOrders = orders.filter(o => o.status === 'cancelled').length;\r\n    } catch (error) {\r\n      console.error('Error loading stats:', error);\r\n    }\r\n  }\r\n\r\n  async loadSalesChart() {\r\n    try {\r\n      const orders = await this.orderService.getOrdersBySeller(this.sellerId);\r\n      \r\n      const salesByDate = new Map<string, number>();\r\n      orders.forEach(order => {\r\n        if (order.status === 'completed' && order.createdAt) {\r\n          const date = new Date(order.createdAt.toDate()).toLocaleDateString();\r\n          salesByDate.set(date, (salesByDate.get(date) || 0) + (order.totalPrice || 0));\r\n        }\r\n      });\r\n\r\n      const sortedDates = Array.from(salesByDate.keys()).sort((a, b) => \r\n        new Date(a).getTime() - new Date(b).getTime()\r\n      );\r\n\r\n      setTimeout(() => {\r\n        if (this.salesChartRef) {\r\n          if (this.salesChart) this.salesChart.destroy();\r\n          \r\n          const ctx = this.salesChartRef.nativeElement.getContext('2d');\r\n          this.salesChart = new Chart(ctx, {\r\n            type: 'line',\r\n            data: {\r\n              labels: sortedDates,\r\n              datasets: [{\r\n                label: 'Sales (₱)',\r\n                data: sortedDates.map(date => salesByDate.get(date) || 0),\r\n                borderColor: '#ffc107',\r\n                backgroundColor: 'rgba(255, 193, 7, 0.1)',\r\n                tension: 0.4,\r\n                fill: true\r\n              }]\r\n            },\r\n            options: {\r\n              responsive: true,\r\n              maintainAspectRatio: false,\r\n              plugins: {\r\n                title: { display: true, text: 'Your Sales Over Time' }\r\n              },\r\n              scales: { y: { beginAtZero: true } }\r\n            }\r\n          });\r\n        }\r\n      }, 100);\r\n    } catch (error) {\r\n      console.error('Error loading sales chart:', error);\r\n    }\r\n  }\r\n\r\n  async loadProductChart() {\r\n    try {\r\n      const products = await this.productService.getProductsBySeller(this.sellerId);\r\n      const orders = await this.orderService.getOrdersBySeller(this.sellerId);\r\n\r\n      const salesByProduct = new Map<string, number>();\r\n      orders.forEach(order => {\r\n        if (order.status === 'completed') {\r\n          order.items.forEach(item => {\r\n            salesByProduct.set(\r\n              item.productName, \r\n              (salesByProduct.get(item.productName) || 0) + (item.price * item.quantity)\r\n            );\r\n          });\r\n        }\r\n      });\r\n\r\n      const topProducts = Array.from(salesByProduct.entries())\r\n        .sort((a, b) => b[1] - a[1])\r\n        .slice(0, 10);\r\n\r\n      setTimeout(() => {\r\n        if (this.productChartRef) {\r\n          if (this.productChart) this.productChart.destroy();\r\n          \r\n          const ctx = this.productChartRef.nativeElement.getContext('2d');\r\n          this.productChart = new Chart(ctx, {\r\n            type: 'bar',\r\n            data: {\r\n              labels: topProducts.map(p => p[0]),\r\n              datasets: [{\r\n                label: 'Revenue (₱)',\r\n                data: topProducts.map(p => p[1]),\r\n                backgroundColor: '#4caf50'\r\n              }]\r\n            },\r\n            options: {\r\n              responsive: true,\r\n              maintainAspectRatio: false,\r\n              plugins: {\r\n                title: { display: true, text: 'Top 10 Products by Revenue' }\r\n              },\r\n              scales: { y: { beginAtZero: true } }\r\n            }\r\n          });\r\n        }\r\n      }, 100);\r\n    } catch (error) {\r\n      console.error('Error loading product chart:', error);\r\n    }\r\n  }\r\n\r\n  async loadStatusChart() {\r\n    try {\r\n      const orders = await this.orderService.getOrdersBySeller(this.sellerId);\r\n      \r\n      const statusCount = {\r\n        pending: 0,\r\n        confirmed: 0,\r\n        completed: 0,\r\n        cancelled: 0\r\n      };\r\n\r\n      orders.forEach(order => {\r\n        const status = order.status || 'pending';\r\n        if (status in statusCount) {\r\n          (statusCount as any)[status]++;\r\n        }\r\n      });\r\n\r\n      setTimeout(() => {\r\n        if (this.statusChartRef) {\r\n          if (this.statusChart) this.statusChart.destroy();\r\n          \r\n          const ctx = this.statusChartRef.nativeElement.getContext('2d');\r\n          this.statusChart = new Chart(ctx, {\r\n            type: 'doughnut',\r\n            data: {\r\n              labels: ['Pending', 'Confirmed', 'Completed', 'Cancelled'],\r\n              datasets: [{\r\n                data: [\r\n                  statusCount.pending,\r\n                  statusCount.confirmed,\r\n                  statusCount.completed,\r\n                  statusCount.cancelled\r\n                ],\r\n                backgroundColor: ['#ff9800', '#2196f3', '#4caf50', '#f44336']\r\n              }]\r\n            },\r\n            options: {\r\n              responsive: true,\r\n              maintainAspectRatio: false,\r\n              plugins: {\r\n                legend: { position: 'bottom' },\r\n                title: { display: true, text: 'Order Status' }\r\n              }\r\n            }\r\n          });\r\n        }\r\n      }, 100);\r\n    } catch (error) {\r\n      console.error('Error loading status chart:', error);\r\n    }\r\n  }\r\n\r\n  async exportPDF() {\r\n    this.loading = true;\r\n    try {\r\n      const element = this.reportContent.nativeElement;\r\n      const canvas = await html2canvas(element, { scale: 2, logging: false });\r\n\r\n      const imgData = canvas.toDataURL('image/png');\r\n      const pdf = new jsPDF('p', 'mm', 'a4');\r\n      const imgWidth = 210;\r\n      const imgHeight = (canvas.height * imgWidth) / canvas.width;\r\n\r\n      pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);\r\n      pdf.save(`Seller-Report-${new Date().toLocaleDateString()}.pdf`);\r\n\r\n      const toast = await this.toastController.create({\r\n        message: 'Report exported successfully!',\r\n        duration: 2000,\r\n        color: 'success'\r\n      });\r\n      await toast.present();\r\n    } catch (error) {\r\n      console.error('Error exporting PDF:', error);\r\n      const toast = await this.toastController.create({\r\n        message: 'Failed to export PDF',\r\n        duration: 3000,\r\n        color: 'danger'\r\n      });\r\n      await toast.present();\r\n    } finally {\r\n      this.loading = false;\r\n    }\r\n  }\r\n\r\n  async refreshReports() {\r\n    await this.loadReports();\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    if (this.salesChart) this.salesChart.destroy();\r\n    if (this.productChart) this.productChart.destroy();\r\n    if (this.statusChart) this.statusChart.destroy();\r\n  }\r\n}\r\n"
        }
    ]
}