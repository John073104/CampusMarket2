{
    "sourceFile": "src/app/modules/seller/pages/add-product/add-product.page.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1763386498376,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763386695445,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -51,12 +51,12 @@\n \r\n   async onFileSelected(event: any) {\r\n     const files = event.target.files;\r\n     if (files && files.length > 0) {\r\n-      // Limit to 5 images\r\n-      if (files.length > 5) {\r\n+      // Limit to 3 images for faster upload (changed from 5)\r\n+      if (files.length > 3) {\r\n         const toast = await this.toastController.create({\r\n-          message: 'Maximum 5 images allowed',\r\n+          message: 'Maximum 3 images allowed for fast upload',\r\n           duration: 2000,\r\n           color: 'warning'\r\n         });\r\n         await toast.present();\r\n@@ -65,20 +65,35 @@\n \r\n       this.selectedFiles = [];\r\n       this.imagePreviews = [];\r\n       \r\n-      // Compress and prepare images\r\n-      for (const file of Array.from(files) as File[]) {\r\n+      // Show progress toast\r\n+      const loadingToast = await this.toastController.create({\r\n+        message: 'Compressing images...',\r\n+        duration: 1500,\r\n+        position: 'bottom'\r\n+      });\r\n+      await loadingToast.present();\r\n+      \r\n+      // Compress and prepare images in parallel\r\n+      const fileArray = Array.from(files) as File[];\r\n+      const compressionPromises = fileArray.map(async (file) => {\r\n         const compressedFile = await this.compressImage(file);\r\n         this.selectedFiles.push(compressedFile);\r\n         \r\n         // Create image preview\r\n-        const reader = new FileReader();\r\n-        reader.onload = (e: any) => {\r\n-          this.imagePreviews.push(e.target.result);\r\n-        };\r\n-        reader.readAsDataURL(compressedFile);\r\n-      }\r\n+        return new Promise<void>((resolve) => {\r\n+          const reader = new FileReader();\r\n+          reader.onload = (e: any) => {\r\n+            this.imagePreviews.push(e.target.result);\r\n+            resolve();\r\n+          };\r\n+          reader.readAsDataURL(compressedFile);\r\n+        });\r\n+      });\r\n+      \r\n+      await Promise.all(compressionPromises);\r\n+      console.log('Images compressed and ready');\r\n     }\r\n   }\r\n \r\n   // Compress image to reduce upload time - OPTIMIZED for speed\r\n"
                },
                {
                    "date": 1763387397117,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -20,12 +20,22 @@\n     title: '',\r\n     description: '',\r\n     price: 0,\r\n     category: 'Other' as ProductCategory,\r\n+    unitType: 'piece' as 'piece' | 'kg' | 'liter' | 'box' | 'pack' | 'dozen',\r\n     stock: 0,\r\n     images: [] as string[]\r\n   };\r\n   \r\n+  unitTypes = [\r\n+    { value: 'piece', label: 'Per Piece' },\r\n+    { value: 'kg', label: 'Per Kilogram (kg)' },\r\n+    { value: 'liter', label: 'Per Liter (L)' },\r\n+    { value: 'box', label: 'Per Box' },\r\n+    { value: 'pack', label: 'Per Pack' },\r\n+    { value: 'dozen', label: 'Per Dozen' }\r\n+  ];\r\n+  \r\n   categories: ProductCategory[] = ['Food', 'Accessories', 'Books', 'Snacks', 'Electronics', 'Clothing', 'Other'];\r\n   selectedFiles: File[] = [];\r\n   uploading: boolean = false;\r\n   imagePreviews: string[] = [];\r\n@@ -223,13 +233,14 @@\n       // Create product with image files (images stored as base64 in Firestore)\r\n       const productId = await this.productService.createProduct({\r\n         sellerId: user.userId!,\r\n         sellerName: user.name || user.email,\r\n-        sellerCourseName: user.courseName || 'N/A', // Add seller's course name\r\n+        sellerCourseName: user.courseName || 'N/A',\r\n         title: this.product.title,\r\n         description: this.product.description,\r\n         price: this.product.price,\r\n         category: this.product.category,\r\n+        unitType: this.product.unitType,\r\n         images: [],\r\n         approved: false,\r\n         stock: this.product.stock\r\n       }, this.selectedFiles);\r\n@@ -275,8 +286,9 @@\n       title: '',\r\n       description: '',\r\n       price: 0,\r\n       category: 'Other' as ProductCategory,\r\n+      unitType: 'piece' as 'piece' | 'kg' | 'liter' | 'box' | 'pack' | 'dozen',\r\n       stock: 0,\r\n       images: []\r\n     };\r\n     this.selectedFiles = [];\r\n"
                }
            ],
            "date": 1763386498376,
            "name": "Commit-0",
            "content": "import { Component, OnInit } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\nimport { IonicModule, AlertController, ToastController, LoadingController } from '@ionic/angular';\r\nimport { Router } from '@angular/router';\r\nimport { ProductService } from '../../../../services/product.service';\r\nimport { AuthService } from '../../../../services/auth.service';\r\nimport { StorageService } from '../../../../services/storage.service';\r\nimport { ProductCategory } from '../../../../models/product.model';\r\n\r\n@Component({\r\n  selector: 'app-add-product',\r\n  templateUrl: './add-product.page.html',\r\n  styleUrls: ['./add-product.page.scss'],\r\n  standalone: true,\r\n  imports: [CommonModule, FormsModule, IonicModule]\r\n})\r\nexport class AddProductPage implements OnInit {\r\n  product = {\r\n    title: '',\r\n    description: '',\r\n    price: 0,\r\n    category: 'Other' as ProductCategory,\r\n    stock: 0,\r\n    images: [] as string[]\r\n  };\r\n  \r\n  categories: ProductCategory[] = ['Food', 'Accessories', 'Books', 'Snacks', 'Electronics', 'Clothing', 'Other'];\r\n  selectedFiles: File[] = [];\r\n  uploading: boolean = false;\r\n  imagePreviews: string[] = [];\r\n  uploadProgress: number = 0;\r\n\r\n  constructor(\r\n    private productService: ProductService,\r\n    private authService: AuthService,\r\n    private storageService: StorageService,\r\n    private router: Router,\r\n    private alertController: AlertController,\r\n    private toastController: ToastController,\r\n    private loadingController: LoadingController\r\n  ) { }\r\n\r\n  ngOnInit() {\r\n  }\r\n\r\n  ionViewWillEnter() {\r\n    // Reset form when entering the page to allow adding multiple products\r\n    this.resetForm();\r\n  }\r\n\r\n  async onFileSelected(event: any) {\r\n    const files = event.target.files;\r\n    if (files && files.length > 0) {\r\n      // Limit to 5 images\r\n      if (files.length > 5) {\r\n        const toast = await this.toastController.create({\r\n          message: 'Maximum 5 images allowed',\r\n          duration: 2000,\r\n          color: 'warning'\r\n        });\r\n        await toast.present();\r\n        return;\r\n      }\r\n\r\n      this.selectedFiles = [];\r\n      this.imagePreviews = [];\r\n      \r\n      // Compress and prepare images\r\n      for (const file of Array.from(files) as File[]) {\r\n        const compressedFile = await this.compressImage(file);\r\n        this.selectedFiles.push(compressedFile);\r\n        \r\n        // Create image preview\r\n        const reader = new FileReader();\r\n        reader.onload = (e: any) => {\r\n          this.imagePreviews.push(e.target.result);\r\n        };\r\n        reader.readAsDataURL(compressedFile);\r\n      }\r\n    }\r\n  }\r\n\r\n  // Compress image to reduce upload time - OPTIMIZED for speed\r\n  async compressImage(file: File): Promise<File> {\r\n    return new Promise((resolve) => {\r\n      const reader = new FileReader();\r\n      reader.onload = (e: any) => {\r\n        const img = new Image();\r\n        img.onload = () => {\r\n          const canvas = document.createElement('canvas');\r\n          let width = img.width;\r\n          let height = img.height;\r\n          \r\n          // Smaller size = faster upload (max 600px instead of 800px)\r\n          const maxSize = 600;\r\n          if (width > maxSize || height > maxSize) {\r\n            if (width > height) {\r\n              height = (height / width) * maxSize;\r\n              width = maxSize;\r\n            } else {\r\n              width = (width / height) * maxSize;\r\n              height = maxSize;\r\n            }\r\n          }\r\n          \r\n          canvas.width = width;\r\n          canvas.height = height;\r\n          \r\n          const ctx = canvas.getContext('2d');\r\n          ctx?.drawImage(img, 0, 0, width, height);\r\n          \r\n          // Lower quality = faster processing (0.5 instead of 0.7)\r\n          canvas.toBlob(\r\n            (blob) => {\r\n              if (blob) {\r\n                const compressedFile = new File([blob], file.name, {\r\n                  type: 'image/jpeg',\r\n                  lastModified: Date.now()\r\n                });\r\n                resolve(compressedFile);\r\n              } else {\r\n                resolve(file);\r\n              }\r\n            },\r\n            'image/jpeg',\r\n            0.5\r\n          );\r\n        };\r\n        img.src = e.target.result;\r\n      };\r\n      reader.readAsDataURL(file);\r\n    });\r\n  }\r\n\r\n  removeImage(index: number) {\r\n    this.selectedFiles.splice(index, 1);\r\n    this.imagePreviews.splice(index, 1);\r\n  }\r\n\r\n  async submitProduct() {\r\n    if (!this.product.title || !this.product.description || this.product.price <= 0) {\r\n      const toast = await this.toastController.create({\r\n        message: 'Please fill in all required fields',\r\n        duration: 2000,\r\n        color: 'warning'\r\n      });\r\n      await toast.present();\r\n      return;\r\n    }\r\n\r\n    if (this.selectedFiles.length === 0) {\r\n      const toast = await this.toastController.create({\r\n        message: 'Please add at least one product image',\r\n        duration: 2000,\r\n        color: 'warning'\r\n      });\r\n      await toast.present();\r\n      return;\r\n    }\r\n\r\n    // Show confirmation\r\n    const alert = await this.alertController.create({\r\n      header: 'Add Product',\r\n      message: 'Submit this product for admin approval?',\r\n      buttons: [\r\n        { text: 'Cancel', role: 'cancel' },\r\n        { \r\n          text: 'Submit', \r\n          role: 'confirm',\r\n          handler: () => this.uploadProduct()\r\n        }\r\n      ]\r\n    });\r\n    await alert.present();\r\n  }\r\n\r\n  async uploadProduct() {\r\n    const loading = await this.loadingController.create({\r\n      message: 'Preparing images...',\r\n      spinner: 'crescent'\r\n    });\r\n    await loading.present();\r\n\r\n    this.uploading = true;\r\n    this.uploadProgress = 0;\r\n    \r\n    try {\r\n      const user = this.authService.getCurrentUser();\r\n      if (!user) {\r\n        await loading.dismiss();\r\n        const toast = await this.toastController.create({\r\n          message: 'User not authenticated. Please log in again.',\r\n          duration: 2000,\r\n          color: 'danger'\r\n        });\r\n        await toast.present();\r\n        return;\r\n      }\r\n\r\n      console.log('Creating product for user:', user.userId, user.email);\r\n      console.log('Product data:', this.product);\r\n      console.log('Image files:', this.selectedFiles.length);\r\n\r\n      // Update loading message\r\n      loading.message = 'Saving product to database...';\r\n      \r\n      // Create product with image files (images stored as base64 in Firestore)\r\n      const productId = await this.productService.createProduct({\r\n        sellerId: user.userId!,\r\n        sellerName: user.name || user.email,\r\n        sellerCourseName: user.courseName || 'N/A', // Add seller's course name\r\n        title: this.product.title,\r\n        description: this.product.description,\r\n        price: this.product.price,\r\n        category: this.product.category,\r\n        images: [],\r\n        approved: false,\r\n        stock: this.product.stock\r\n      }, this.selectedFiles);\r\n\r\n      console.log('Product created successfully with ID:', productId);\r\n      \r\n      await loading.dismiss();\r\n\r\n      const toast = await this.toastController.create({\r\n        message: 'Product submitted successfully! Waiting for admin approval.',\r\n        duration: 3000,\r\n        color: 'success',\r\n        position: 'top'\r\n      });\r\n      await toast.present();\r\n\r\n      // Reset form to allow adding more products\r\n      this.resetForm();\r\n      \r\n      // Navigate to products page\r\n      this.router.navigate(['/seller/products']);\r\n    } catch (error: any) {\r\n      console.error('Error creating product:', error);\r\n      console.error('Error details:', error.message, error.code);\r\n      await loading.dismiss();\r\n\r\n      const toast = await this.toastController.create({\r\n        message: `Failed to upload product: ${error.message || 'Please try again later.'}`,\r\n        duration: 3000,\r\n        color: 'danger',\r\n        position: 'top'\r\n      });\r\n      await toast.present();\r\n    } finally {\r\n      this.uploading = false;\r\n      this.uploadProgress = 0;\r\n    }\r\n  }\r\n\r\n  // Reset form after successful submission\r\n  resetForm() {\r\n    this.product = {\r\n      title: '',\r\n      description: '',\r\n      price: 0,\r\n      category: 'Other' as ProductCategory,\r\n      stock: 0,\r\n      images: []\r\n    };\r\n    this.selectedFiles = [];\r\n    this.imagePreviews = [];\r\n    this.uploadProgress = 0;\r\n  }\r\n\r\n  goBack() {\r\n    this.router.navigate(['/seller/dashboard']);\r\n  }\r\n}\r\n\r\n"
        }
    ]
}