{
    "sourceFile": "src/app/modules/admin/pages/analytics/analytics.page.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1764630445645,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1764630871279,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,5 @@\n-import { Component, OnInit, AfterViewInit, ViewChild, ElementRef } from '@angular/core';\r\n+import { Component, OnInit, AfterViewInit, ViewChild, ElementRef, OnDestroy, ChangeDetectorRef, inject } from '@angular/core';\r\n import { CommonModule } from '@angular/common';\r\n import { FormsModule } from '@angular/forms';\r\n import { IonicModule } from '@ionic/angular';\r\n import { Router } from '@angular/router';\r\n@@ -17,16 +17,21 @@\n   styleUrls: ['./analytics.page.scss'],\r\n   standalone: true,\r\n   imports: [CommonModule, FormsModule, IonicModule]\r\n })\r\n-export class AnalyticsPage implements OnInit, AfterViewInit {\r\n-  @ViewChild('salesChart') salesChartRef!: ElementRef;\r\n-  @ViewChild('categoryChart') categoryChartRef!: ElementRef;\r\n+export class AnalyticsPage implements OnInit, AfterViewInit, OnDestroy {\r\n+  @ViewChild('salesChart', { static: false }) salesChartRef!: ElementRef;\r\n+  @ViewChild('categoryChart', { static: false }) categoryChartRef!: ElementRef;\r\n \r\n   salesChart: Chart | null = null;\r\n   categoryChart: Chart | null = null;\r\n   loading = true;\r\n+  chartsReady = false;\r\n   \r\n+  // Pre-loaded data for charts\r\n+  private allOrders: any[] = [];\r\n+  private allProducts: any[] = [];\r\n+  \r\n   stats = {\r\n     totalUsers: 0,\r\n     totalProducts: 0,\r\n     totalOrders: 0,\r\n@@ -37,47 +42,67 @@\n   };\r\n   \r\n   recentOrders: Order[] = [];\r\n \r\n-  constructor(\r\n-    private orderService: OrderService,\r\n-    private productService: ProductService,\r\n-    private userService: UserService,\r\n-    private router: Router\r\n-  ) { }\r\n+  // Use inject() for proper Angular injection context\r\n+  private orderService = inject(OrderService);\r\n+  private productService = inject(ProductService);\r\n+  private userService = inject(UserService);\r\n+  private router = inject(Router);\r\n+  private cdr = inject(ChangeDetectorRef);\r\n \r\n   async ngOnInit() {\r\n+    // Only load data in ngOnInit, NOT charts\r\n     await this.loadAnalytics();\r\n   }\r\n \r\n   ngAfterViewInit() {\r\n-    console.log('Analytics view initialized');\r\n+    // Wait for Ionic to fully render the view\r\n+    // This ensures canvas elements are in DOM before we try to access them\r\n     setTimeout(() => {\r\n-      this.loadCharts();\r\n-    }, 500);\r\n+      this.initializeChartsWhenReady();\r\n+    }, 100);\r\n   }\r\n \r\n   ionViewDidEnter() {\r\n-    console.log('Analytics view entered');\r\n-    setTimeout(() => {\r\n-      if (!this.salesChart || !this.categoryChart) {\r\n-        console.log('Charts missing, reloading...');\r\n-        this.loadCharts();\r\n-      }\r\n-    }, 300);\r\n+    // Only reinitialize if charts were destroyed or never created\r\n+    if (!this.chartsReady && !this.loading) {\r\n+      setTimeout(() => {\r\n+        this.initializeChartsWhenReady();\r\n+      }, 100);\r\n+    }\r\n   }\r\n \r\n+  private initializeChartsWhenReady() {\r\n+    // Verify canvas elements exist before proceeding\r\n+    const salesCanvas = this.salesChartRef?.nativeElement;\r\n+    const categoryCanvas = this.categoryChartRef?.nativeElement;\r\n+\r\n+    if (!salesCanvas || !categoryCanvas) {\r\n+      console.warn('âš ï¸ Canvas elements not ready, waiting...');\r\n+      return;\r\n+    }\r\n+\r\n+    console.log('âœ… Canvas elements ready, initializing charts');\r\n+    this.chartsReady = true;\r\n+    this.loadCharts();\r\n+  }\r\n+\r\n   async loadAnalytics() {\r\n     this.loading = true;\r\n     try {\r\n-      // Load platform statistics\r\n+      // Load platform statistics and cache data for charts\r\n       const [platformStats, users, products, allOrders] = await Promise.all([\r\n         this.orderService.getPlatformStats(),\r\n         this.userService.getAllUsers(),\r\n         this.productService.getAllProducts(),\r\n         this.orderService.getAllOrders()\r\n       ]);\r\n \r\n+      // Cache data for chart rendering\r\n+      this.allOrders = allOrders;\r\n+      this.allProducts = products;\r\n+\r\n       this.stats.totalUsers = users.length;\r\n       this.stats.totalProducts = products.filter((p: any) => p.approved).length;\r\n       this.stats.pendingProducts = products.filter((p: any) => !p.approved).length;\r\n       this.stats.totalOrders = platformStats.totalOrders;\r\n@@ -86,12 +111,15 @@\n       this.stats.revenueToday = platformStats.revenueToday;\r\n \r\n       // Get recent orders (last 5)\r\n       this.recentOrders = allOrders.slice(0, 5);\r\n+\r\n+      console.log('âœ… Analytics data loaded successfully');\r\n     } catch (error) {\r\n-      console.error('Error loading analytics:', error);\r\n+      console.error('âŒ Error loading analytics:', error);\r\n     } finally {\r\n       this.loading = false;\r\n+      this.cdr.detectChanges();\r\n     }\r\n   }\r\n \r\n   async loadCharts() {\r\n"
                },
                {
                    "date": 1764630890856,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -122,11 +122,16 @@\n     }\r\n   }\r\n \r\n   async loadCharts() {\r\n+    if (!this.chartsReady) {\r\n+      console.warn('âš ï¸ Charts not ready yet');\r\n+      return;\r\n+    }\r\n+\r\n     try {\r\n+      // Use cached data instead of making new Firebase calls\r\n       await this.loadSalesChart();\r\n-      await new Promise(resolve => setTimeout(resolve, 200));\r\n       await this.loadCategoryChart();\r\n       console.log('âœ… Charts loaded successfully');\r\n     } catch (error) {\r\n       console.error('âŒ Error loading charts:', error);\r\n@@ -134,16 +139,17 @@\n   }\r\n \r\n   async loadSalesChart() {\r\n     try {\r\n-      console.log('ðŸ”¥ Loading Sales Chart...');\r\n+      console.log('ðŸ“Š Initializing Sales Chart...');\r\n       \r\n       const canvas = this.salesChartRef?.nativeElement;\r\n       if (!canvas) {\r\n         console.error('âŒ Sales canvas not found');\r\n         return;\r\n       }\r\n       \r\n+      // Ensure canvas is visible\r\n       canvas.style.display = 'block';\r\n       canvas.style.visibility = 'visible';\r\n       const parent = canvas.parentElement;\r\n       if (parent) {\r\n@@ -156,17 +162,18 @@\n       \r\n       const ctx = canvas.getContext('2d');\r\n       if (!ctx) return;\r\n \r\n+      // Destroy existing chart\r\n       if (this.salesChart) {\r\n         this.salesChart.destroy();\r\n         this.salesChart = null;\r\n       }\r\n \r\n-      const orders = await this.orderService.getAllOrders();\r\n+      // Use cached data - NO Firebase calls here\r\n       const last7Days = this.getLast7Days();\r\n       const salesByDay = last7Days.map(date => {\r\n-        const dayOrders = orders.filter((o: any) => {\r\n+        const dayOrders = this.allOrders.filter((o: any) => {\r\n           const orderDate = o.createdAt?.toDate ? o.createdAt.toDate() : new Date(o.createdAt);\r\n           return orderDate.toDateString() === date.toDateString() && o.status === 'completed';\r\n         });\r\n         return dayOrders.reduce((sum: number, o: any) => sum + (o.totalPrice || 0), 0);\r\n@@ -219,16 +226,17 @@\n   }\r\n \r\n   async loadCategoryChart() {\r\n     try {\r\n-      console.log('ðŸ”¥ Loading Category Chart...');\r\n+      console.log('ðŸ“Š Initializing Category Chart...');\r\n \r\n       const canvas = this.categoryChartRef?.nativeElement;\r\n       if (!canvas) {\r\n         console.error('âŒ Category canvas not found');\r\n         return;\r\n       }\r\n       \r\n+      // Ensure canvas is visible\r\n       canvas.style.display = 'block';\r\n       canvas.style.visibility = 'visible';\r\n       const parent = canvas.parentElement;\r\n       if (parent) {\r\n@@ -241,16 +249,17 @@\n       \r\n       const ctx = canvas.getContext('2d');\r\n       if (!ctx) return;\r\n \r\n+      // Destroy existing chart\r\n       if (this.categoryChart) {\r\n         this.categoryChart.destroy();\r\n         this.categoryChart = null;\r\n       }\r\n \r\n-      const products = await this.productService.getAllProducts();\r\n+      // Use cached data - NO Firebase calls here\r\n       const categoryCount: { [key: string]: number } = {};\r\n-      products.forEach((p: any) => {\r\n+      this.allProducts.forEach((p: any) => {\r\n         const cat = p.category || 'Other';\r\n         categoryCount[cat] = (categoryCount[cat] || 0) + 1;\r\n       });\r\n \r\n"
                }
            ],
            "date": 1764630445644,
            "name": "Commit-0",
            "content": "import { Component, OnInit, AfterViewInit, ViewChild, ElementRef } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\nimport { IonicModule } from '@ionic/angular';\r\nimport { Router } from '@angular/router';\r\nimport { OrderService } from '../../../../services/order.service';\r\nimport { ProductService } from '../../../../services/product.service';\r\nimport { UserService } from '../../../../services/user.service';\r\nimport { Order } from '../../../../models/order.model';\r\nimport { Chart, ChartConfiguration, registerables } from 'chart.js';\r\n\r\nChart.register(...registerables);\r\n\r\n@Component({\r\n  selector: 'app-analytics',\r\n  templateUrl: './analytics.page.html',\r\n  styleUrls: ['./analytics.page.scss'],\r\n  standalone: true,\r\n  imports: [CommonModule, FormsModule, IonicModule]\r\n})\r\nexport class AnalyticsPage implements OnInit, AfterViewInit {\r\n  @ViewChild('salesChart') salesChartRef!: ElementRef;\r\n  @ViewChild('categoryChart') categoryChartRef!: ElementRef;\r\n\r\n  salesChart: Chart | null = null;\r\n  categoryChart: Chart | null = null;\r\n  loading = true;\r\n  \r\n  stats = {\r\n    totalUsers: 0,\r\n    totalProducts: 0,\r\n    totalOrders: 0,\r\n    totalRevenue: 0,\r\n    ordersToday: 0,\r\n    revenueToday: 0,\r\n    pendingProducts: 0\r\n  };\r\n  \r\n  recentOrders: Order[] = [];\r\n\r\n  constructor(\r\n    private orderService: OrderService,\r\n    private productService: ProductService,\r\n    private userService: UserService,\r\n    private router: Router\r\n  ) { }\r\n\r\n  async ngOnInit() {\r\n    await this.loadAnalytics();\r\n  }\r\n\r\n  ngAfterViewInit() {\r\n    console.log('Analytics view initialized');\r\n    setTimeout(() => {\r\n      this.loadCharts();\r\n    }, 500);\r\n  }\r\n\r\n  ionViewDidEnter() {\r\n    console.log('Analytics view entered');\r\n    setTimeout(() => {\r\n      if (!this.salesChart || !this.categoryChart) {\r\n        console.log('Charts missing, reloading...');\r\n        this.loadCharts();\r\n      }\r\n    }, 300);\r\n  }\r\n\r\n  async loadAnalytics() {\r\n    this.loading = true;\r\n    try {\r\n      // Load platform statistics\r\n      const [platformStats, users, products, allOrders] = await Promise.all([\r\n        this.orderService.getPlatformStats(),\r\n        this.userService.getAllUsers(),\r\n        this.productService.getAllProducts(),\r\n        this.orderService.getAllOrders()\r\n      ]);\r\n\r\n      this.stats.totalUsers = users.length;\r\n      this.stats.totalProducts = products.filter((p: any) => p.approved).length;\r\n      this.stats.pendingProducts = products.filter((p: any) => !p.approved).length;\r\n      this.stats.totalOrders = platformStats.totalOrders;\r\n      this.stats.totalRevenue = platformStats.totalRevenue;\r\n      this.stats.ordersToday = platformStats.ordersToday;\r\n      this.stats.revenueToday = platformStats.revenueToday;\r\n\r\n      // Get recent orders (last 5)\r\n      this.recentOrders = allOrders.slice(0, 5);\r\n    } catch (error) {\r\n      console.error('Error loading analytics:', error);\r\n    } finally {\r\n      this.loading = false;\r\n    }\r\n  }\r\n\r\n  async loadCharts() {\r\n    try {\r\n      await this.loadSalesChart();\r\n      await new Promise(resolve => setTimeout(resolve, 200));\r\n      await this.loadCategoryChart();\r\n      console.log('âœ… Charts loaded successfully');\r\n    } catch (error) {\r\n      console.error('âŒ Error loading charts:', error);\r\n    }\r\n  }\r\n\r\n  async loadSalesChart() {\r\n    try {\r\n      console.log('ðŸ”¥ Loading Sales Chart...');\r\n      \r\n      const canvas = this.salesChartRef?.nativeElement;\r\n      if (!canvas) {\r\n        console.error('âŒ Sales canvas not found');\r\n        return;\r\n      }\r\n      \r\n      canvas.style.display = 'block';\r\n      canvas.style.visibility = 'visible';\r\n      const parent = canvas.parentElement;\r\n      if (parent) {\r\n        parent.style.display = 'block';\r\n        parent.style.height = '250px';\r\n      }\r\n      \r\n      canvas.width = parent?.offsetWidth || 350;\r\n      canvas.height = 250;\r\n      \r\n      const ctx = canvas.getContext('2d');\r\n      if (!ctx) return;\r\n\r\n      if (this.salesChart) {\r\n        this.salesChart.destroy();\r\n        this.salesChart = null;\r\n      }\r\n\r\n      const orders = await this.orderService.getAllOrders();\r\n      const last7Days = this.getLast7Days();\r\n      const salesByDay = last7Days.map(date => {\r\n        const dayOrders = orders.filter((o: any) => {\r\n          const orderDate = o.createdAt?.toDate ? o.createdAt.toDate() : new Date(o.createdAt);\r\n          return orderDate.toDateString() === date.toDateString() && o.status === 'completed';\r\n        });\r\n        return dayOrders.reduce((sum: number, o: any) => sum + (o.totalPrice || 0), 0);\r\n      });\r\n\r\n      this.salesChart = new Chart(ctx, {\r\n        type: 'line',\r\n        data: {\r\n          labels: last7Days.map(d => d.toLocaleDateString('en-US', { weekday: 'short' })),\r\n          datasets: [{\r\n            label: 'Sales (â‚±)',\r\n            data: salesByDay,\r\n            borderColor: '#2dd36f',\r\n            backgroundColor: 'rgba(45, 211, 111, 0.2)',\r\n            borderWidth: 3,\r\n            tension: 0.4,\r\n            fill: true,\r\n            pointRadius: 5,\r\n            pointBackgroundColor: '#2dd36f'\r\n          }]\r\n        },\r\n        options: {\r\n          responsive: true,\r\n          maintainAspectRatio: false,\r\n          plugins: {\r\n            legend: {\r\n              display: true,\r\n              labels: { color: '#000', font: { size: 12 } }\r\n            }\r\n          },\r\n          scales: {\r\n            y: {\r\n              beginAtZero: true,\r\n              ticks: { color: '#000' },\r\n              grid: { color: 'rgba(0,0,0,0.1)' }\r\n            },\r\n            x: {\r\n              ticks: { color: '#000' },\r\n              grid: { display: false }\r\n            }\r\n          }\r\n        }\r\n      });\r\n\r\n      this.salesChart.update();\r\n      console.log('âœ… Sales chart created');\r\n    } catch (error) {\r\n      console.error('âŒ Sales chart error:', error);\r\n    }\r\n  }\r\n\r\n  async loadCategoryChart() {\r\n    try {\r\n      console.log('ðŸ”¥ Loading Category Chart...');\r\n\r\n      const canvas = this.categoryChartRef?.nativeElement;\r\n      if (!canvas) {\r\n        console.error('âŒ Category canvas not found');\r\n        return;\r\n      }\r\n      \r\n      canvas.style.display = 'block';\r\n      canvas.style.visibility = 'visible';\r\n      const parent = canvas.parentElement;\r\n      if (parent) {\r\n        parent.style.display = 'block';\r\n        parent.style.height = '250px';\r\n      }\r\n      \r\n      canvas.width = parent?.offsetWidth || 350;\r\n      canvas.height = 250;\r\n      \r\n      const ctx = canvas.getContext('2d');\r\n      if (!ctx) return;\r\n\r\n      if (this.categoryChart) {\r\n        this.categoryChart.destroy();\r\n        this.categoryChart = null;\r\n      }\r\n\r\n      const products = await this.productService.getAllProducts();\r\n      const categoryCount: { [key: string]: number } = {};\r\n      products.forEach((p: any) => {\r\n        const cat = p.category || 'Other';\r\n        categoryCount[cat] = (categoryCount[cat] || 0) + 1;\r\n      });\r\n\r\n      const categories = Object.keys(categoryCount);\r\n      const counts = Object.values(categoryCount);\r\n\r\n      this.categoryChart = new Chart(ctx, {\r\n        type: 'pie',\r\n        data: {\r\n          labels: categories,\r\n          datasets: [{\r\n            data: counts,\r\n            backgroundColor: [\r\n              '#2dd36f',\r\n              '#3dc2ff',\r\n              '#ffc409',\r\n              '#eb445a',\r\n              '#92949c',\r\n              '#5260ff',\r\n              '#1aa051',\r\n              '#0d8fd9',\r\n              '#ffab00',\r\n              '#c5000f'\r\n            ],\r\n            borderColor: '#ffffff',\r\n            borderWidth: 2\r\n          }]\r\n        },\r\n        options: {\r\n          responsive: true,\r\n          maintainAspectRatio: false,\r\n          plugins: {\r\n            legend: {\r\n              display: true,\r\n              position: 'right',\r\n              labels: {\r\n                color: '#000',\r\n                font: { size: 10 },\r\n                padding: 10,\r\n                usePointStyle: true\r\n              }\r\n            }\r\n          }\r\n        }\r\n      });\r\n\r\n      this.categoryChart.update();\r\n      console.log('âœ… Category chart created');\r\n    } catch (error) {\r\n      console.error('âŒ Category chart error:', error);\r\n    }\r\n  }\r\n\r\n  private getLast7Days(): Date[] {\r\n    const days: Date[] = [];\r\n    for (let i = 6; i >= 0; i--) {\r\n      const date = new Date();\r\n      date.setDate(date.getDate() - i);\r\n      days.push(date);\r\n    }\r\n    return days;\r\n  }\r\n\r\n  goBack() {\r\n    this.router.navigate(['/admin/dashboard']);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    if (this.salesChart) this.salesChart.destroy();\r\n    if (this.categoryChart) this.categoryChart.destroy();\r\n  }\r\n}\r\n"
        }
    ]
}