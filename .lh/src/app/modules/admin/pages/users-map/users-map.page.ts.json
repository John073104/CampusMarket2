{
    "sourceFile": "src/app/modules/admin/pages/users-map/users-map.page.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1763641024717,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1763641024717,
            "name": "Commit-0",
            "content": "import { Component, OnInit, AfterViewInit, OnDestroy } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\nimport { IonicModule } from '@ionic/angular';\r\nimport { UserService } from '../../../../services/user.service';\r\nimport { User } from '../../../../models/user.model';\r\nimport * as L from 'leaflet';\r\n\r\n@Component({\r\n  selector: 'app-users-map',\r\n  templateUrl: './users-map.page.html',\r\n  styleUrls: ['./users-map.page.scss'],\r\n  standalone: true,\r\n  imports: [CommonModule, FormsModule, IonicModule]\r\n})\r\nexport class UsersMapPage implements OnInit, AfterViewInit, OnDestroy {\r\n  private map: L.Map | null = null;\r\n  users: User[] = [];\r\n  loading = true;\r\n  filterRole: 'all' | 'customer' | 'seller' | 'admin' = 'all';\r\n\r\n  constructor(private userService: UserService) {}\r\n\r\n  ngOnInit() {\r\n    this.loadUsers();\r\n  }\r\n\r\n  ngAfterViewInit() {\r\n    setTimeout(() => {\r\n      this.initializeMap();\r\n    }, 100);\r\n  }\r\n\r\n  async loadUsers() {\r\n    this.loading = true;\r\n    try {\r\n      this.users = await this.userService.getAllUsers();\r\n      this.updateMapMarkers();\r\n    } catch (error) {\r\n      console.error('Error loading users:', error);\r\n    } finally {\r\n      this.loading = false;\r\n    }\r\n  }\r\n\r\n  private initializeMap() {\r\n    // Fix Leaflet icon issue\r\n    const iconRetinaUrl = 'assets/marker-icon-2x.png';\r\n    const iconUrl = 'assets/marker-icon.png';\r\n    const shadowUrl = 'assets/marker-shadow.png';\r\n    const iconDefault = L.icon({\r\n      iconRetinaUrl,\r\n      iconUrl,\r\n      shadowUrl,\r\n      iconSize: [25, 41],\r\n      iconAnchor: [12, 41],\r\n      popupAnchor: [1, -34],\r\n      tooltipAnchor: [16, -28],\r\n      shadowSize: [41, 41]\r\n    });\r\n    L.Marker.prototype.options.icon = iconDefault;\r\n\r\n    // Default center: Philippines\r\n    this.map = L.map('map').setView([14.5995, 120.9842], 12);\r\n\r\n    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\r\n      attribution: 'Â© OpenStreetMap contributors',\r\n      maxZoom: 19\r\n    }).addTo(this.map);\r\n\r\n    this.updateMapMarkers();\r\n  }\r\n\r\n  private updateMapMarkers() {\r\n    if (!this.map) return;\r\n\r\n    // Clear existing markers\r\n    this.map.eachLayer((layer) => {\r\n      if (layer instanceof L.Marker) {\r\n        this.map!.removeLayer(layer);\r\n      }\r\n    });\r\n\r\n    // Filter users\r\n    const filteredUsers = this.filterRole === 'all' \r\n      ? this.users \r\n      : this.users.filter(u => u.role === this.filterRole);\r\n\r\n    // Add markers for users with locations\r\n    const usersWithLocation = filteredUsers.filter(u => u.location);\r\n    \r\n    if (usersWithLocation.length === 0) return;\r\n\r\n    usersWithLocation.forEach(user => {\r\n      if (user.location) {\r\n        const marker = L.marker([user.location.latitude, user.location.longitude]);\r\n        \r\n        // Create popup content\r\n        const popupContent = `\r\n          <div style=\"min-width: 200px;\">\r\n            <h3 style=\"margin: 0 0 8px 0; color: var(--ion-color-primary);\">${user.name}</h3>\r\n            <p style=\"margin: 4px 0;\"><strong>Role:</strong> ${user.role.toUpperCase()}</p>\r\n            <p style=\"margin: 4px 0;\"><strong>Email:</strong> ${user.email}</p>\r\n            ${user.phone ? `<p style=\"margin: 4px 0;\"><strong>Phone:</strong> ${user.phone}</p>` : ''}\r\n            ${user.courseName ? `<p style=\"margin: 4px 0;\"><strong>Course:</strong> ${user.courseName}</p>` : ''}\r\n            ${user.location.address ? `<p style=\"margin: 4px 0; font-size: 0.9em; color: #666;\">${user.location.address}</p>` : ''}\r\n          </div>\r\n        `;\r\n        \r\n        marker.bindPopup(popupContent);\r\n        marker.addTo(this.map!);\r\n      }\r\n    });\r\n\r\n    // Fit bounds to show all markers\r\n    const bounds = L.latLngBounds(\r\n      usersWithLocation.map(u => [u.location!.latitude, u.location!.longitude])\r\n    );\r\n    this.map.fitBounds(bounds, { padding: [50, 50] });\r\n  }\r\n\r\n  onFilterChange() {\r\n    this.updateMapMarkers();\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    if (this.map) {\r\n      this.map.remove();\r\n      this.map = null;\r\n    }\r\n  }\r\n}\r\n"
        }
    ]
}