{
    "sourceFile": "src/app/modules/admin/pages/reports/reports.page.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1763388132036,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763389074206,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -105,9 +105,9 @@\n         .filter((o: any) => o.status === 'completed')\r\n         .reduce((sum: number, order: any) => sum + (order.totalPrice || 0), 0);\r\n \r\n       this.stats.completedOrders = orders.filter((o: any) => o.status === 'completed').length;\r\n-      this.stats.pendingOrders = orders.filter((o: any) => o.status === 'pending').length;\r\n+      this.stats.pendingOrders = orders.filter((o: any) => o.status === 'placed').length;\r\n       this.stats.cancelledOrders = orders.filter((o: any) => o.status === 'cancelled').length;\r\n     } catch (error) {\r\n       console.error('Error loading stats:', error);\r\n     }\r\n@@ -274,16 +274,17 @@\n     try {\r\n       const orders = await this.orderService.getAllOrders();\r\n       \r\n       const statusCount = {\r\n-        pending: 0,\r\n+        placed: 0,\r\n         confirmed: 0,\r\n+        ready_for_pickup: 0,\r\n         completed: 0,\r\n         cancelled: 0\r\n       };\r\n \r\n       orders.forEach((order: any) => {\r\n-        const status = order.status || 'pending';\r\n+        const status = order.status || 'placed';\r\n         if (status in statusCount) {\r\n           (statusCount as any)[status]++;\r\n         }\r\n       });\r\n@@ -295,17 +296,18 @@\n           const ctx = this.statusChartRef.nativeElement.getContext('2d');\r\n           this.statusChart = new Chart(ctx, {\r\n             type: 'doughnut',\r\n             data: {\r\n-              labels: ['Pending', 'Confirmed', 'Completed', 'Cancelled'],\r\n+              labels: ['Placed', 'Confirmed', 'Ready for Pickup', 'Completed', 'Cancelled'],\r\n               datasets: [{\r\n                 data: [\r\n-                  statusCount.pending,\r\n+                  statusCount.placed,\r\n                   statusCount.confirmed,\r\n+                  statusCount.ready_for_pickup,\r\n                   statusCount.completed,\r\n                   statusCount.cancelled\r\n                 ],\r\n-                backgroundColor: ['#ff9800', '#2196f3', '#4caf50', '#f44336']\r\n+                backgroundColor: ['#ff9800', '#2196f3', '#9c27b0', '#4caf50', '#f44336']\r\n               }]\r\n             },\r\n             options: {\r\n               responsive: true,\r\n"
                }
            ],
            "date": 1763388132036,
            "name": "Commit-0",
            "content": "import { Component, OnInit, ViewChild, ElementRef } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\nimport { IonicModule, AlertController, ToastController } from '@ionic/angular';\r\nimport { OrderService } from 'src/app/services/order.service';\r\nimport { ProductService } from 'src/app/services/product.service';\r\nimport { UserService } from 'src/app/services/user.service';\r\nimport { Chart, ChartConfiguration, registerables } from 'chart.js';\r\nimport jsPDF from 'jspdf';\r\nimport html2canvas from 'html2canvas';\r\n\r\nChart.register(...registerables);\r\n\r\ninterface SalesData {\r\n  date: string;\r\n  total: number;\r\n}\r\n\r\ninterface CategoryData {\r\n  category: string;\r\n  count: number;\r\n}\r\n\r\n@Component({\r\n  selector: 'app-reports',\r\n  templateUrl: './reports.page.html',\r\n  styleUrls: ['./reports.page.scss'],\r\n  standalone: true,\r\n  imports: [CommonModule, FormsModule, IonicModule]\r\n})\r\nexport class ReportsPage implements OnInit {\r\n  @ViewChild('salesChart') salesChartRef!: ElementRef;\r\n  @ViewChild('categoryChart') categoryChartRef!: ElementRef;\r\n  @ViewChild('topSellersChart') topSellersChartRef!: ElementRef;\r\n  @ViewChild('statusChart') statusChartRef!: ElementRef;\r\n  @ViewChild('reportContent') reportContent!: ElementRef;\r\n\r\n  salesChart: Chart | null = null;\r\n  categoryChart: Chart | null = null;\r\n  topSellersChart: Chart | null = null;\r\n  statusChart: Chart | null = null;\r\n\r\n  loading = false;\r\n  dateRange = {\r\n    start: new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().split('T')[0],\r\n    end: new Date().toISOString().split('T')[0]\r\n  };\r\n\r\n  stats = {\r\n    totalSales: 0,\r\n    totalOrders: 0,\r\n    totalProducts: 0,\r\n    totalUsers: 0,\r\n    completedOrders: 0,\r\n    pendingOrders: 0,\r\n    cancelledOrders: 0\r\n  };\r\n\r\n  constructor(\r\n    private orderService: OrderService,\r\n    private productService: ProductService,\r\n    private userService: UserService,\r\n    private alertController: AlertController,\r\n    private toastController: ToastController\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.loadReports();\r\n  }\r\n\r\n  async loadReports() {\r\n    this.loading = true;\r\n    try {\r\n      await Promise.all([\r\n        this.loadStats(),\r\n        this.loadSalesChart(),\r\n        this.loadCategoryChart(),\r\n        this.loadTopSellersChart(),\r\n        this.loadStatusChart()\r\n      ]);\r\n    } catch (error) {\r\n      console.error('Error loading reports:', error);\r\n      const toast = await this.toastController.create({\r\n        message: 'Failed to load reports',\r\n        duration: 3000,\r\n        color: 'danger'\r\n      });\r\n      await toast.present();\r\n    } finally {\r\n      this.loading = false;\r\n    }\r\n  }\r\n\r\n  async loadStats() {\r\n    try {\r\n      const orders = await this.orderService.getAllOrders();\r\n      const products = await this.productService.getAllProducts();\r\n      const users = await this.userService.getAllUsers();\r\n\r\n      this.stats.totalOrders = orders.length;\r\n      this.stats.totalProducts = products.length;\r\n      this.stats.totalUsers = users.length;\r\n\r\n      this.stats.totalSales = orders\r\n        .filter((o: any) => o.status === 'completed')\r\n        .reduce((sum: number, order: any) => sum + (order.totalPrice || 0), 0);\r\n\r\n      this.stats.completedOrders = orders.filter((o: any) => o.status === 'completed').length;\r\n      this.stats.pendingOrders = orders.filter((o: any) => o.status === 'pending').length;\r\n      this.stats.cancelledOrders = orders.filter((o: any) => o.status === 'cancelled').length;\r\n    } catch (error) {\r\n      console.error('Error loading stats:', error);\r\n    }\r\n  }\r\n\r\n  async loadSalesChart() {\r\n    try {\r\n      const orders = await this.orderService.getAllOrders();\r\n      \r\n      // Group orders by date\r\n      const salesByDate = new Map<string, number>();\r\n      orders.forEach((order: any) => {\r\n        if (order.status === 'completed' && order.createdAt) {\r\n          const date = new Date(order.createdAt.toDate()).toLocaleDateString();\r\n          const current = salesByDate.get(date) || 0;\r\n          salesByDate.set(date, current + (order.totalPrice || 0));\r\n        }\r\n      });\r\n\r\n      const sortedDates = Array.from(salesByDate.keys()).sort((a, b) => \r\n        new Date(a).getTime() - new Date(b).getTime()\r\n      );\r\n\r\n      const data = sortedDates.map(date => salesByDate.get(date) || 0);\r\n\r\n      setTimeout(() => {\r\n        if (this.salesChartRef) {\r\n          if (this.salesChart) this.salesChart.destroy();\r\n          \r\n          const ctx = this.salesChartRef.nativeElement.getContext('2d');\r\n          this.salesChart = new Chart(ctx, {\r\n            type: 'line',\r\n            data: {\r\n              labels: sortedDates,\r\n              datasets: [{\r\n                label: 'Sales (₱)',\r\n                data: data,\r\n                borderColor: '#ffc107',\r\n                backgroundColor: 'rgba(255, 193, 7, 0.1)',\r\n                tension: 0.4,\r\n                fill: true\r\n              }]\r\n            },\r\n            options: {\r\n              responsive: true,\r\n              maintainAspectRatio: false,\r\n              plugins: {\r\n                legend: { display: true },\r\n                title: { display: true, text: 'Sales Over Time' }\r\n              },\r\n              scales: {\r\n                y: { beginAtZero: true }\r\n              }\r\n            }\r\n          });\r\n        }\r\n      }, 100);\r\n    } catch (error) {\r\n      console.error('Error loading sales chart:', error);\r\n    }\r\n  }\r\n\r\n  async loadCategoryChart() {\r\n    try {\r\n      const products = await this.productService.getAllProducts();\r\n      \r\n      const categoryCount = new Map<string, number>();\r\n      products.forEach((product: any) => {\r\n        const category = product.category || 'Other';\r\n        categoryCount.set(category, (categoryCount.get(category) || 0) + 1);\r\n      });\r\n\r\n      const categories = Array.from(categoryCount.keys());\r\n      const counts = categories.map(cat => categoryCount.get(cat) || 0);\r\n\r\n      setTimeout(() => {\r\n        if (this.categoryChartRef) {\r\n          if (this.categoryChart) this.categoryChart.destroy();\r\n          \r\n          const ctx = this.categoryChartRef.nativeElement.getContext('2d');\r\n          this.categoryChart = new Chart(ctx, {\r\n            type: 'pie',\r\n            data: {\r\n              labels: categories,\r\n              datasets: [{\r\n                data: counts,\r\n                backgroundColor: [\r\n                  '#ffc107', '#4caf50', '#2196f3', '#ff5722', '#9c27b0', '#00bcd4', '#ff9800'\r\n                ]\r\n              }]\r\n            },\r\n            options: {\r\n              responsive: true,\r\n              maintainAspectRatio: false,\r\n              plugins: {\r\n                legend: { position: 'right' },\r\n                title: { display: true, text: 'Products by Category' }\r\n              }\r\n            }\r\n          });\r\n        }\r\n      }, 100);\r\n    } catch (error) {\r\n      console.error('Error loading category chart:', error);\r\n    }\r\n  }\r\n\r\n  async loadTopSellersChart() {\r\n    try {\r\n      const orders = await this.orderService.getAllOrders();\r\n      const users = await this.userService.getAllUsers();\r\n      \r\n      const salesBySeller = new Map<string, { name: string; total: number }>();\r\n      \r\n      orders.forEach((order: any) => {\r\n        if (order.status === 'completed') {\r\n          const sellerId = order.sellerId;\r\n          const current = salesBySeller.get(sellerId) || { name: order.sellerName, total: 0 };\r\n          current.total += order.totalPrice || 0;\r\n          salesBySeller.set(sellerId, current);\r\n        }\r\n      });\r\n\r\n      const topSellers = Array.from(salesBySeller.values())\r\n        .sort((a, b) => b.total - a.total)\r\n        .slice(0, 10);\r\n\r\n      setTimeout(() => {\r\n        if (this.topSellersChartRef) {\r\n          if (this.topSellersChart) this.topSellersChart.destroy();\r\n          \r\n          const ctx = this.topSellersChartRef.nativeElement.getContext('2d');\r\n          this.topSellersChart = new Chart(ctx, {\r\n            type: 'bar',\r\n            data: {\r\n              labels: topSellers.map(s => s.name),\r\n              datasets: [{\r\n                label: 'Sales (₱)',\r\n                data: topSellers.map(s => s.total),\r\n                backgroundColor: '#4caf50'\r\n              }]\r\n            },\r\n            options: {\r\n              responsive: true,\r\n              maintainAspectRatio: false,\r\n              indexAxis: 'y',\r\n              plugins: {\r\n                legend: { display: false },\r\n                title: { display: true, text: 'Top 10 Sellers' }\r\n              },\r\n              scales: {\r\n                x: { beginAtZero: true }\r\n              }\r\n            }\r\n          });\r\n        }\r\n      }, 100);\r\n    } catch (error) {\r\n      console.error('Error loading top sellers chart:', error);\r\n    }\r\n  }\r\n\r\n  async loadStatusChart() {\r\n    try {\r\n      const orders = await this.orderService.getAllOrders();\r\n      \r\n      const statusCount = {\r\n        pending: 0,\r\n        confirmed: 0,\r\n        completed: 0,\r\n        cancelled: 0\r\n      };\r\n\r\n      orders.forEach((order: any) => {\r\n        const status = order.status || 'pending';\r\n        if (status in statusCount) {\r\n          (statusCount as any)[status]++;\r\n        }\r\n      });\r\n\r\n      setTimeout(() => {\r\n        if (this.statusChartRef) {\r\n          if (this.statusChart) this.statusChart.destroy();\r\n          \r\n          const ctx = this.statusChartRef.nativeElement.getContext('2d');\r\n          this.statusChart = new Chart(ctx, {\r\n            type: 'doughnut',\r\n            data: {\r\n              labels: ['Pending', 'Confirmed', 'Completed', 'Cancelled'],\r\n              datasets: [{\r\n                data: [\r\n                  statusCount.pending,\r\n                  statusCount.confirmed,\r\n                  statusCount.completed,\r\n                  statusCount.cancelled\r\n                ],\r\n                backgroundColor: ['#ff9800', '#2196f3', '#4caf50', '#f44336']\r\n              }]\r\n            },\r\n            options: {\r\n              responsive: true,\r\n              maintainAspectRatio: false,\r\n              plugins: {\r\n                legend: { position: 'bottom' },\r\n                title: { display: true, text: 'Order Status Breakdown' }\r\n              }\r\n            }\r\n          });\r\n        }\r\n      }, 100);\r\n    } catch (error) {\r\n      console.error('Error loading status chart:', error);\r\n    }\r\n  }\r\n\r\n  async printReport() {\r\n    window.print();\r\n  }\r\n\r\n  async exportPDF() {\r\n    this.loading = true;\r\n    try {\r\n      const element = this.reportContent.nativeElement;\r\n      const canvas = await html2canvas(element, {\r\n        scale: 2,\r\n        logging: false,\r\n        useCORS: true\r\n      });\r\n\r\n      const imgData = canvas.toDataURL('image/png');\r\n      const pdf = new jsPDF('p', 'mm', 'a4');\r\n      const imgWidth = 210; // A4 width in mm\r\n      const imgHeight = (canvas.height * imgWidth) / canvas.width;\r\n      \r\n      let heightLeft = imgHeight;\r\n      let position = 0;\r\n\r\n      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);\r\n      heightLeft -= 297; // A4 height\r\n\r\n      while (heightLeft >= 0) {\r\n        position = heightLeft - imgHeight;\r\n        pdf.addPage();\r\n        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);\r\n        heightLeft -= 297;\r\n      }\r\n\r\n      pdf.save(`CampusMarket-Report-${new Date().toLocaleDateString()}.pdf`);\r\n\r\n      const toast = await this.toastController.create({\r\n        message: 'Report exported successfully!',\r\n        duration: 2000,\r\n        color: 'success'\r\n      });\r\n      await toast.present();\r\n    } catch (error) {\r\n      console.error('Error exporting PDF:', error);\r\n      const toast = await this.toastController.create({\r\n        message: 'Failed to export PDF',\r\n        duration: 3000,\r\n        color: 'danger'\r\n      });\r\n      await toast.present();\r\n    } finally {\r\n      this.loading = false;\r\n    }\r\n  }\r\n\r\n  async refreshReports() {\r\n    await this.loadReports();\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    if (this.salesChart) this.salesChart.destroy();\r\n    if (this.categoryChart) this.categoryChart.destroy();\r\n    if (this.topSellersChart) this.topSellersChart.destroy();\r\n    if (this.statusChart) this.statusChart.destroy();\r\n  }\r\n}\r\n"
        }
    ]
}