{
    "sourceFile": "src/app/modules/admin/pages/chat/chat.page.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1764592013839,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1764592013839,
            "name": "Commit-0",
            "content": "import { Component, OnInit, ViewChild, ElementRef, OnDestroy } from '@angular/core';\r\nimport { CommonModule, DatePipe } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\nimport { IonicModule } from '@ionic/angular';\r\nimport { ActivatedRoute, Router } from '@angular/router';\r\nimport { ChatService } from '../../../../services/chat.service';\r\nimport { AuthService } from '../../../../services/auth.service';\r\nimport { Chat, Message } from '../../../../models/chat.model';\r\nimport { Subscription } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'app-chat',\r\n  templateUrl: './chat.page.html',\r\n  styleUrls: ['./chat.page.scss'],\r\n  standalone: true,\r\n  imports: [CommonModule, FormsModule, IonicModule, DatePipe]\r\n})\r\nexport class ChatPage implements OnInit, OnDestroy {\r\n  @ViewChild('chatContent', { read: ElementRef }) chatContent?: ElementRef;\r\n  \r\n  chat: Chat | null = null;\r\n  messages: Message[] = [];\r\n  newMessage = '';\r\n  loading = true;\r\n  currentUserId = '';\r\n  currentUserName = '';\r\n  otherUserName = '';\r\n  chatId = '';\r\n  private messagesSubscription?: Subscription;\r\n\r\n  constructor(\r\n    private route: ActivatedRoute,\r\n    private router: Router,\r\n    private chatService: ChatService,\r\n    private authService: AuthService\r\n  ) { }\r\n\r\n  async ngOnInit() {\r\n    const user = this.authService.getCurrentUser();\r\n    if (!user || !user.userId) {\r\n      this.router.navigate(['/auth/login']);\r\n      return;\r\n    }\r\n    \r\n    this.currentUserId = user.userId;\r\n    this.currentUserName = user.name || user.email;\r\n    \r\n    this.chatId = this.route.snapshot.paramMap.get('id') || '';\r\n    if (this.chatId) {\r\n      await this.loadChat();\r\n      this.loadMessages();\r\n    } else {\r\n      this.loading = false;\r\n    }\r\n  }\r\n\r\n  async loadChat() {\r\n    try {\r\n      this.chat = await this.chatService.getChatById(this.chatId);\r\n      if (!this.chat) {\r\n        console.error('Chat not found');\r\n        this.router.navigate(['/admin/messages']);\r\n        return;\r\n      }\r\n      const otherUserId = this.chat.participantIds.find(id => id !== this.currentUserId);\r\n      this.otherUserName = otherUserId ? this.chat.participantNames[otherUserId] : 'Unknown';\r\n      \r\n      // Mark as read (non-blocking)\r\n      this.chatService.markMessagesAsRead(this.chatId, this.currentUserId)\r\n        .catch(err => console.warn('Could not mark messages as read:', err));\r\n      \r\n      this.loading = false;\r\n    } catch (error) {\r\n      console.error('Error loading chat:', error);\r\n      this.loading = false;\r\n      this.router.navigate(['/admin/messages']);\r\n    }\r\n  }\r\n\r\n  loadMessages() {\r\n    if (!this.chatId) {\r\n      console.error('No chat ID provided');\r\n      return;\r\n    }\r\n    \r\n    this.messagesSubscription = this.chatService.getMessages(this.chatId).subscribe({\r\n      next: (messages) => {\r\n        this.messages = messages;\r\n        setTimeout(() => this.scrollToBottom(), 100);\r\n      },\r\n      error: (error) => {\r\n        console.error('Error loading messages:', error);\r\n        this.messages = [];\r\n      }\r\n    });\r\n  }\r\n\r\n  async sendMessage() {\r\n    if (!this.newMessage.trim() || !this.chatId) return;\r\n\r\n    try {\r\n      await this.chatService.sendMessage(\r\n        this.chatId,\r\n        this.currentUserId,\r\n        this.currentUserName,\r\n        this.newMessage.trim()\r\n      );\r\n      \r\n      this.newMessage = '';\r\n      setTimeout(() => this.scrollToBottom(), 100);\r\n    } catch (error) {\r\n      console.error('Error sending message:', error);\r\n    }\r\n  }\r\n\r\n  scrollToBottom() {\r\n    if (this.chatContent) {\r\n      const element = this.chatContent.nativeElement;\r\n      element.scrollTop = element.scrollHeight;\r\n    }\r\n  }\r\n\r\n  goBack() {\r\n    this.router.navigate(['/admin/messages']);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    if (this.messagesSubscription) {\r\n      this.messagesSubscription.unsubscribe();\r\n    }\r\n  }\r\n}\r\n"
        }
    ]
}