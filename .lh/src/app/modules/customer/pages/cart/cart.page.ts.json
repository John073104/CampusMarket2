{
    "sourceFile": "src/app/modules/customer/pages/cart/cart.page.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1763384538015,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763389651862,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -197,8 +197,9 @@\n       // Group items by seller\r\n       const itemsBySeller = this.cartService.getCartItemsBySeller();\r\n       \r\n       // Create an order for each seller\r\n+      console.log('Creating orders for sellers...', itemsBySeller.size);\r\n       for (const [sellerId, items] of itemsBySeller) {\r\n         const orderItems: any[] = items.map(item => ({\r\n           productId: item.productId,\r\n           productName: item.productName,\r\n@@ -208,17 +209,29 @@\n         }));\r\n         \r\n         const total = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);\r\n         \r\n-        await this.orderService.createOrder(\r\n+        console.log('Creating order:', {\r\n+          customerId: user.userId,\r\n+          sellerId,\r\n+          total,\r\n+          itemCount: orderItems.length,\r\n+          deliveryInfo: this.checkoutData\r\n+        });\r\n+        \r\n+        const orderId = await this.orderService.createOrder(\r\n           user.userId!,\r\n           user.name || user.email,\r\n           sellerId,\r\n           items[0].sellerName,\r\n           orderItems,\r\n           total,\r\n-          this.checkoutData\r\n+          this.checkoutData,\r\n+          undefined,\r\n+          `Payment: ${this.checkoutData.paymentMethod}`\r\n         );\r\n+        \r\n+        console.log('Order created successfully:', orderId);\r\n       }\r\n \r\n       // Clear cart\r\n       await this.cartService.clearCart();\r\n@@ -235,13 +248,19 @@\n       // Navigate to orders\r\n       setTimeout(() => {\r\n         this.router.navigate(['/customer/orders']);\r\n       }, 1000);\r\n-    } catch (error) {\r\n+    } catch (error: any) {\r\n       console.error('Error during checkout:', error);\r\n+      console.error('Error details:', {\r\n+        message: error?.message,\r\n+        code: error?.code,\r\n+        stack: error?.stack\r\n+      });\r\n+      \r\n       const toast = await this.toastController.create({\r\n-        message: 'Failed to place order. Please try again.',\r\n-        duration: 3000,\r\n+        message: `Failed to place order: ${error?.message || 'Please check your internet connection and try again.'}`,\r\n+        duration: 5000,\r\n         color: 'danger',\r\n         position: 'top'\r\n       });\r\n       await toast.present();\r\n"
                }
            ],
            "date": 1763384538015,
            "name": "Commit-0",
            "content": "import { Component, OnInit } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\nimport { IonicModule, AlertController, ToastController } from '@ionic/angular';\r\nimport { Router } from '@angular/router';\r\nimport { CartService, CartItem } from '../../../../services/cart.service';\r\nimport { OrderService } from '../../../../services/order.service';\r\nimport { AuthService } from '../../../../services/auth.service';\r\nimport { ProductService } from '../../../../services/product.service';\r\n\r\n@Component({\r\n  selector: 'app-cart',\r\n  templateUrl: './cart.page.html',\r\n  styleUrls: ['./cart.page.scss'],\r\n  standalone: true,\r\n  imports: [CommonModule, FormsModule, IonicModule]\r\n})\r\nexport class CartPage implements OnInit {\r\n  cartItems: CartItem[] = [];\r\n  loading: boolean = false;\r\n  \r\n  // Checkout form data\r\n  checkoutData = {\r\n    name: '',\r\n    phone: '',\r\n    address: '',\r\n    paymentMethod: 'cash_on_delivery'\r\n  };\r\n\r\n  constructor(\r\n    private cartService: CartService,\r\n    private orderService: OrderService,\r\n    private authService: AuthService,\r\n    private productService: ProductService,\r\n    private router: Router,\r\n    private alertController: AlertController,\r\n    private toastController: ToastController\r\n  ) { }\r\n\r\n  ngOnInit() {\r\n    this.loadCart();\r\n    this.loadUserData();\r\n  }\r\n\r\n  ionViewWillEnter() {\r\n    this.loadCart();\r\n  }\r\n\r\n  async loadCart() {\r\n    this.cartItems = this.cartService.getCartItems();\r\n  }\r\n\r\n  loadUserData() {\r\n    const user = this.authService.getCurrentUser();\r\n    if (user) {\r\n      this.checkoutData.name = user.name || '';\r\n      this.checkoutData.phone = user.phone || '';\r\n    }\r\n  }\r\n\r\n  async updateQuantity(item: CartItem, change: number) {\r\n    const newQuantity = item.quantity + change;\r\n    if (newQuantity > 0) {\r\n      // Check if new quantity exceeds stock\r\n      try {\r\n        const product = await this.productService.getProductById(item.productId);\r\n        if (product && newQuantity > product.stock) {\r\n          const toast = await this.toastController.create({\r\n            message: `Only ${product.stock} items available in stock`,\r\n            duration: 2000,\r\n            color: 'warning',\r\n            position: 'top'\r\n          });\r\n          await toast.present();\r\n          return;\r\n        }\r\n      } catch (error) {\r\n        console.error('Error checking stock:', error);\r\n      }\r\n      \r\n      await this.cartService.updateQuantity(item.productId, newQuantity);\r\n      this.loadCart();\r\n    }\r\n  }\r\n\r\n  async removeItem(productId: string) {\r\n    await this.cartService.removeFromCart(productId);\r\n    this.loadCart();\r\n  }\r\n\r\n  getTotal(): number {\r\n    return this.cartService.getCartTotal();\r\n  }\r\n\r\n  getItemCount(): number {\r\n    return this.cartService.getCartCount();\r\n  }\r\n\r\n  async checkout() {\r\n    if (this.cartItems.length === 0) return;\r\n    \r\n    // Show checkout form first\r\n    const alert = await this.alertController.create({\r\n      header: 'Checkout Information',\r\n      inputs: [\r\n        {\r\n          name: 'name',\r\n          type: 'text',\r\n          placeholder: 'Full Name',\r\n          value: this.checkoutData.name\r\n        },\r\n        {\r\n          name: 'phone',\r\n          type: 'tel',\r\n          placeholder: 'Phone Number',\r\n          value: this.checkoutData.phone\r\n        },\r\n        {\r\n          name: 'address',\r\n          type: 'textarea',\r\n          placeholder: 'Delivery Address',\r\n          value: this.checkoutData.address\r\n        }\r\n      ],\r\n      buttons: [\r\n        {\r\n          text: 'Cancel',\r\n          role: 'cancel'\r\n        },\r\n        {\r\n          text: 'Place Order',\r\n          handler: async (data) => {\r\n            if (!data.name || !data.phone || !data.address) {\r\n              const toast = await this.toastController.create({\r\n                message: 'Please fill in all required fields',\r\n                duration: 2000,\r\n                color: 'warning',\r\n                position: 'top'\r\n              });\r\n              await toast.present();\r\n              return false;\r\n            }\r\n            \r\n            this.checkoutData = {\r\n              ...data,\r\n              paymentMethod: 'cash_on_delivery'\r\n            };\r\n            \r\n            await this.processCheckout();\r\n            return true;\r\n          }\r\n        }\r\n      ]\r\n    });\r\n\r\n    await alert.present();\r\n  }\r\n\r\n  async processCheckout() {\r\n    this.loading = true;\r\n    try {\r\n      const user = this.authService.getCurrentUser();\r\n      if (!user) {\r\n        this.router.navigate(['/auth/login']);\r\n        return;\r\n      }\r\n\r\n      // Validate stock for all items\r\n      for (const item of this.cartItems) {\r\n        const product = await this.productService.getProductById(item.productId);\r\n        if (!product) {\r\n          const toast = await this.toastController.create({\r\n            message: `Product \"${item.productName}\" no longer available`,\r\n            duration: 3000,\r\n            color: 'danger',\r\n            position: 'top'\r\n          });\r\n          await toast.present();\r\n          await this.removeItem(item.productId);\r\n          this.loading = false;\r\n          return;\r\n        }\r\n        \r\n        if (item.quantity > product.stock) {\r\n          const toast = await this.toastController.create({\r\n            message: `Only ${product.stock} of \"${item.productName}\" available`,\r\n            duration: 3000,\r\n            color: 'warning',\r\n            position: 'top'\r\n          });\r\n          await toast.present();\r\n          this.loading = false;\r\n          return;\r\n        }\r\n      }\r\n\r\n      // Group items by seller\r\n      const itemsBySeller = this.cartService.getCartItemsBySeller();\r\n      \r\n      // Create an order for each seller\r\n      for (const [sellerId, items] of itemsBySeller) {\r\n        const orderItems: any[] = items.map(item => ({\r\n          productId: item.productId,\r\n          productName: item.productName,\r\n          price: item.price,\r\n          quantity: item.quantity,\r\n          productImage: item.productImage\r\n        }));\r\n        \r\n        const total = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);\r\n        \r\n        await this.orderService.createOrder(\r\n          user.userId!,\r\n          user.name || user.email,\r\n          sellerId,\r\n          items[0].sellerName,\r\n          orderItems,\r\n          total,\r\n          this.checkoutData\r\n        );\r\n      }\r\n\r\n      // Clear cart\r\n      await this.cartService.clearCart();\r\n      \r\n      // Show success message\r\n      const toast = await this.toastController.create({\r\n        message: 'ðŸŽ‰ Order placed successfully! Track it in \"My Orders\"',\r\n        duration: 3000,\r\n        color: 'success',\r\n        position: 'top'\r\n      });\r\n      await toast.present();\r\n      \r\n      // Navigate to orders\r\n      setTimeout(() => {\r\n        this.router.navigate(['/customer/orders']);\r\n      }, 1000);\r\n    } catch (error) {\r\n      console.error('Error during checkout:', error);\r\n      const toast = await this.toastController.create({\r\n        message: 'Failed to place order. Please try again.',\r\n        duration: 3000,\r\n        color: 'danger',\r\n        position: 'top'\r\n      });\r\n      await toast.present();\r\n    } finally {\r\n      this.loading = false;\r\n    }\r\n  }\r\n\r\n  continueShopping() {\r\n    this.router.navigate(['/customer/products']);\r\n  }\r\n}\r\n\r\n"
        }
    ]
}