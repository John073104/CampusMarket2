{
    "sourceFile": "src/app/modules/customer/pages/chats/chats.page.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1763384538027,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763386695471,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -44,16 +44,31 @@\n     this.loadChats();\r\n   }\r\n \r\n   loadChats() {\r\n+    console.log('Loading chats for user:', this.currentUserId);\r\n+    \r\n+    // Set timeout to prevent infinite loading\r\n+    const timeout = setTimeout(() => {\r\n+      if (this.loading) {\r\n+        console.warn('Chat loading timeout - setting empty state');\r\n+        this.loading = false;\r\n+        this.chats = [];\r\n+      }\r\n+    }, 5000); // 5 second timeout\r\n+    \r\n     this.chatService.getUserChats(this.currentUserId).subscribe({\r\n       next: (chats) => {\r\n+        clearTimeout(timeout);\r\n         this.chats = chats;\r\n         this.loading = false;\r\n+        console.log('Loaded chats:', chats.length);\r\n       },\r\n       error: (error) => {\r\n+        clearTimeout(timeout);\r\n         console.error('Error loading chats:', error);\r\n         this.loading = false;\r\n+        this.chats = [];\r\n       }\r\n     });\r\n   }\r\n \r\n"
                }
            ],
            "date": 1763384538027,
            "name": "Commit-0",
            "content": "import { Component, OnInit, ViewChild, ElementRef } from '@angular/core';\r\nimport { CommonModule, DatePipe } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\nimport { IonicModule } from '@ionic/angular';\r\nimport { Router } from '@angular/router';\r\nimport { ChatService } from '../../../../services/chat.service';\r\nimport { AuthService } from '../../../../services/auth.service';\r\nimport { Chat, Message } from '../../../../models/chat.model';\r\n\r\n@Component({\r\n  selector: 'app-chats',\r\n  templateUrl: './chats.page.html',\r\n  styleUrls: ['./chats.page.scss'],\r\n  standalone: true,\r\n  imports: [CommonModule, FormsModule, IonicModule, DatePipe]\r\n})\r\nexport class ChatsPage implements OnInit {\r\n  @ViewChild('chatContent', { read: ElementRef }) chatContent?: ElementRef;\r\n  \r\n  chats: Chat[] = [];\r\n  selectedChat: Chat | null = null;\r\n  messages: Message[] = [];\r\n  newMessage = '';\r\n  loading = true;\r\n  currentUserId = '';\r\n  currentUserName = '';\r\n\r\n  constructor(\r\n    private chatService: ChatService,\r\n    private authService: AuthService,\r\n    private router: Router\r\n  ) { }\r\n\r\n  async ngOnInit() {\r\n    const user = this.authService.getCurrentUser();\r\n    if (!user || !user.userId) {\r\n      this.router.navigate(['/login']);\r\n      return;\r\n    }\r\n    \r\n    this.currentUserId = user.userId;\r\n    this.currentUserName = user.name || user.email;\r\n    \r\n    this.loadChats();\r\n  }\r\n\r\n  loadChats() {\r\n    this.chatService.getUserChats(this.currentUserId).subscribe({\r\n      next: (chats) => {\r\n        this.chats = chats;\r\n        this.loading = false;\r\n      },\r\n      error: (error) => {\r\n        console.error('Error loading chats:', error);\r\n        this.loading = false;\r\n      }\r\n    });\r\n  }\r\n\r\n  selectChat(chat: Chat) {\r\n    this.selectedChat = chat;\r\n    if (chat.chatId) {\r\n      this.loadMessages(chat.chatId);\r\n      this.chatService.markMessagesAsRead(chat.chatId, this.currentUserId);\r\n    }\r\n  }\r\n\r\n  loadMessages(chatId: string) {\r\n    this.chatService.getMessages(chatId).subscribe({\r\n      next: (messages) => {\r\n        this.messages = messages;\r\n        setTimeout(() => this.scrollToBottom(), 100);\r\n      },\r\n      error: (error) => {\r\n        console.error('Error loading messages:', error);\r\n      }\r\n    });\r\n  }\r\n\r\n  async sendMessage() {\r\n    if (!this.newMessage.trim() || !this.selectedChat || !this.selectedChat.chatId) return;\r\n\r\n    try {\r\n      await this.chatService.sendMessage(\r\n        this.selectedChat.chatId,\r\n        this.currentUserId,\r\n        this.currentUserName,\r\n        this.newMessage.trim()\r\n      );\r\n      \r\n      this.newMessage = '';\r\n      setTimeout(() => this.scrollToBottom(), 100);\r\n    } catch (error) {\r\n      console.error('Error sending message:', error);\r\n    }\r\n  }\r\n\r\n  scrollToBottom() {\r\n    if (this.chatContent) {\r\n      const element = this.chatContent.nativeElement;\r\n      element.scrollTop = element.scrollHeight;\r\n    }\r\n  }\r\n\r\n  getOtherParticipantName(chat: Chat): string {\r\n    const otherUserId = chat.participantIds.find(id => id !== this.currentUserId);\r\n    return otherUserId ? chat.participantNames[otherUserId] : 'Unknown';\r\n  }\r\n\r\n  getUnreadCount(chat: Chat): number {\r\n    return chat.unreadCount[this.currentUserId] || 0;\r\n  }\r\n\r\n  goBack() {\r\n    if (this.selectedChat) {\r\n      this.selectedChat = null;\r\n      this.messages = [];\r\n    } else {\r\n      this.router.navigate(['/customer/dashboard']);\r\n    }\r\n  }\r\n}\r\n\r\n"
        }
    ]
}