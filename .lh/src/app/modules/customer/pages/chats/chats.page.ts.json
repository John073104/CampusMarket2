{
    "sourceFile": "src/app/modules/customer/pages/chats/chats.page.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1763384538027,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763386695471,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -44,16 +44,31 @@\n     this.loadChats();\r\n   }\r\n \r\n   loadChats() {\r\n+    console.log('Loading chats for user:', this.currentUserId);\r\n+    \r\n+    // Set timeout to prevent infinite loading\r\n+    const timeout = setTimeout(() => {\r\n+      if (this.loading) {\r\n+        console.warn('Chat loading timeout - setting empty state');\r\n+        this.loading = false;\r\n+        this.chats = [];\r\n+      }\r\n+    }, 5000); // 5 second timeout\r\n+    \r\n     this.chatService.getUserChats(this.currentUserId).subscribe({\r\n       next: (chats) => {\r\n+        clearTimeout(timeout);\r\n         this.chats = chats;\r\n         this.loading = false;\r\n+        console.log('Loaded chats:', chats.length);\r\n       },\r\n       error: (error) => {\r\n+        clearTimeout(timeout);\r\n         console.error('Error loading chats:', error);\r\n         this.loading = false;\r\n+        this.chats = [];\r\n       }\r\n     });\r\n   }\r\n \r\n"
                },
                {
                    "date": 1763461219194,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,12 +1,14 @@\n import { Component, OnInit, ViewChild, ElementRef } from '@angular/core';\r\n import { CommonModule, DatePipe } from '@angular/common';\r\n import { FormsModule } from '@angular/forms';\r\n-import { IonicModule } from '@ionic/angular';\r\n+import { IonicModule, ModalController, AlertController } from '@ionic/angular';\r\n import { Router } from '@angular/router';\r\n import { ChatService } from '../../../../services/chat.service';\r\n import { AuthService } from '../../../../services/auth.service';\r\n+import { UserService } from '../../../../services/user.service';\r\n import { Chat, Message } from '../../../../models/chat.model';\r\n+import { User } from '../../../../models/user.model';\r\n \r\n @Component({\r\n   selector: 'app-chats',\r\n   templateUrl: './chats.page.html',\r\n@@ -27,9 +29,11 @@\n \r\n   constructor(\r\n     private chatService: ChatService,\r\n     private authService: AuthService,\r\n-    private router: Router\r\n+    private userService: UserService,\r\n+    private router: Router,\r\n+    private alertController: AlertController\r\n   ) { }\r\n \r\n   async ngOnInit() {\r\n     const user = this.authService.getCurrentUser();\r\n@@ -133,6 +137,142 @@\n     } else {\r\n       this.router.navigate(['/customer/dashboard']);\r\n     }\r\n   }\r\n+\r\n+  async openNewChatModal() {\r\n+    const alert = await this.alertController.create({\r\n+      header: 'Start New Chat',\r\n+      message: 'Who would you like to chat with?',\r\n+      buttons: [\r\n+        {\r\n+          text: 'Cancel',\r\n+          role: 'cancel'\r\n+        },\r\n+        {\r\n+          text: 'Contact Admin',\r\n+          handler: () => this.selectAdminToChat()\r\n+        },\r\n+        {\r\n+          text: 'Chat with Seller',\r\n+          handler: () => this.selectSellerToChat()\r\n+        }\r\n+      ]\r\n+    });\r\n+    await alert.present();\r\n+  }\r\n+\r\n+  async selectAdminToChat() {\r\n+    try {\r\n+      const admins = await this.userService.getAdminUsers();\r\n+      if (admins.length === 0) {\r\n+        const alert = await this.alertController.create({\r\n+          header: 'No Admins Available',\r\n+          message: 'No administrators are currently available.',\r\n+          buttons: ['OK']\r\n+        });\r\n+        await alert.present();\r\n+        return;\r\n+      }\r\n+\r\n+      const inputs = admins.map(admin => ({\r\n+        type: 'radio' as const,\r\n+        label: admin.name || admin.email,\r\n+        value: admin.userId\r\n+      }));\r\n+\r\n+      const alert = await this.alertController.create({\r\n+        header: 'Select Admin',\r\n+        inputs: inputs,\r\n+        buttons: [\r\n+          {\r\n+            text: 'Cancel',\r\n+            role: 'cancel'\r\n+          },\r\n+          {\r\n+            text: 'Start Chat',\r\n+            handler: async (adminId) => {\r\n+              if (adminId) {\r\n+                const admin = admins.find(a => a.userId === adminId);\r\n+                if (admin) {\r\n+                  await this.startNewChat(admin.userId!, admin.name || admin.email);\r\n+                }\r\n+              }\r\n+            }\r\n+          }\r\n+        ]\r\n+      });\r\n+      await alert.present();\r\n+    } catch (error) {\r\n+      console.error('Error loading admins:', error);\r\n+    }\r\n+  }\r\n+\r\n+  async selectSellerToChat() {\r\n+    try {\r\n+      const sellers = await this.userService.getSellerUsers();\r\n+      if (sellers.length === 0) {\r\n+        const alert = await this.alertController.create({\r\n+          header: 'No Sellers Available',\r\n+          message: 'No sellers are currently available. Browse products to chat with sellers!',\r\n+          buttons: ['OK']\r\n+        });\r\n+        await alert.present();\r\n+        return;\r\n+      }\r\n+\r\n+      const inputs = sellers.map(seller => ({\r\n+        type: 'radio' as const,\r\n+        label: `${seller.name || seller.email}${seller.courseName ? ' - ' + seller.courseName : ''}`,\r\n+        value: seller.userId\r\n+      }));\r\n+\r\n+      const alert = await this.alertController.create({\r\n+        header: 'Select Seller',\r\n+        inputs: inputs,\r\n+        buttons: [\r\n+          {\r\n+            text: 'Cancel',\r\n+            role: 'cancel'\r\n+          },\r\n+          {\r\n+            text: 'Start Chat',\r\n+            handler: async (sellerId) => {\r\n+              if (sellerId) {\r\n+                const seller = sellers.find(s => s.userId === sellerId);\r\n+                if (seller) {\r\n+                  await this.startNewChat(seller.userId!, seller.name || seller.email);\r\n+                }\r\n+              }\r\n+            }\r\n+          }\r\n+        ]\r\n+      });\r\n+      await alert.present();\r\n+    } catch (error) {\r\n+      console.error('Error loading sellers:', error);\r\n+    }\r\n+  }\r\n+\r\n+  async startNewChat(otherUserId: string, otherUserName: string) {\r\n+    try {\r\n+      const chatId = await this.chatService.getOrCreateChat(\r\n+        this.currentUserId,\r\n+        this.currentUserName,\r\n+        otherUserId,\r\n+        otherUserName\r\n+      );\r\n+      \r\n+      // Navigate to the chat\r\n+      this.router.navigate(['/customer/chat', chatId]);\r\n+    } catch (error) {\r\n+      console.error('Error starting chat:', error);\r\n+      const alert = await this.alertController.create({\r\n+        header: 'Error',\r\n+        message: 'Failed to start chat. Please try again.',\r\n+        buttons: ['OK']\r\n+      });\r\n+      await alert.present();\r\n+    }\r\n+  }\r\n }\r\n \r\n"
                }
            ],
            "date": 1763384538027,
            "name": "Commit-0",
            "content": "import { Component, OnInit, ViewChild, ElementRef } from '@angular/core';\r\nimport { CommonModule, DatePipe } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\nimport { IonicModule } from '@ionic/angular';\r\nimport { Router } from '@angular/router';\r\nimport { ChatService } from '../../../../services/chat.service';\r\nimport { AuthService } from '../../../../services/auth.service';\r\nimport { Chat, Message } from '../../../../models/chat.model';\r\n\r\n@Component({\r\n  selector: 'app-chats',\r\n  templateUrl: './chats.page.html',\r\n  styleUrls: ['./chats.page.scss'],\r\n  standalone: true,\r\n  imports: [CommonModule, FormsModule, IonicModule, DatePipe]\r\n})\r\nexport class ChatsPage implements OnInit {\r\n  @ViewChild('chatContent', { read: ElementRef }) chatContent?: ElementRef;\r\n  \r\n  chats: Chat[] = [];\r\n  selectedChat: Chat | null = null;\r\n  messages: Message[] = [];\r\n  newMessage = '';\r\n  loading = true;\r\n  currentUserId = '';\r\n  currentUserName = '';\r\n\r\n  constructor(\r\n    private chatService: ChatService,\r\n    private authService: AuthService,\r\n    private router: Router\r\n  ) { }\r\n\r\n  async ngOnInit() {\r\n    const user = this.authService.getCurrentUser();\r\n    if (!user || !user.userId) {\r\n      this.router.navigate(['/login']);\r\n      return;\r\n    }\r\n    \r\n    this.currentUserId = user.userId;\r\n    this.currentUserName = user.name || user.email;\r\n    \r\n    this.loadChats();\r\n  }\r\n\r\n  loadChats() {\r\n    this.chatService.getUserChats(this.currentUserId).subscribe({\r\n      next: (chats) => {\r\n        this.chats = chats;\r\n        this.loading = false;\r\n      },\r\n      error: (error) => {\r\n        console.error('Error loading chats:', error);\r\n        this.loading = false;\r\n      }\r\n    });\r\n  }\r\n\r\n  selectChat(chat: Chat) {\r\n    this.selectedChat = chat;\r\n    if (chat.chatId) {\r\n      this.loadMessages(chat.chatId);\r\n      this.chatService.markMessagesAsRead(chat.chatId, this.currentUserId);\r\n    }\r\n  }\r\n\r\n  loadMessages(chatId: string) {\r\n    this.chatService.getMessages(chatId).subscribe({\r\n      next: (messages) => {\r\n        this.messages = messages;\r\n        setTimeout(() => this.scrollToBottom(), 100);\r\n      },\r\n      error: (error) => {\r\n        console.error('Error loading messages:', error);\r\n      }\r\n    });\r\n  }\r\n\r\n  async sendMessage() {\r\n    if (!this.newMessage.trim() || !this.selectedChat || !this.selectedChat.chatId) return;\r\n\r\n    try {\r\n      await this.chatService.sendMessage(\r\n        this.selectedChat.chatId,\r\n        this.currentUserId,\r\n        this.currentUserName,\r\n        this.newMessage.trim()\r\n      );\r\n      \r\n      this.newMessage = '';\r\n      setTimeout(() => this.scrollToBottom(), 100);\r\n    } catch (error) {\r\n      console.error('Error sending message:', error);\r\n    }\r\n  }\r\n\r\n  scrollToBottom() {\r\n    if (this.chatContent) {\r\n      const element = this.chatContent.nativeElement;\r\n      element.scrollTop = element.scrollHeight;\r\n    }\r\n  }\r\n\r\n  getOtherParticipantName(chat: Chat): string {\r\n    const otherUserId = chat.participantIds.find(id => id !== this.currentUserId);\r\n    return otherUserId ? chat.participantNames[otherUserId] : 'Unknown';\r\n  }\r\n\r\n  getUnreadCount(chat: Chat): number {\r\n    return chat.unreadCount[this.currentUserId] || 0;\r\n  }\r\n\r\n  goBack() {\r\n    if (this.selectedChat) {\r\n      this.selectedChat = null;\r\n      this.messages = [];\r\n    } else {\r\n      this.router.navigate(['/customer/dashboard']);\r\n    }\r\n  }\r\n}\r\n\r\n"
        }
    ]
}