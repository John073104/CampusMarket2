{
    "sourceFile": "MESSAGING_GUIDE.md",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1763388303169,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1763388303169,
            "name": "Commit-0",
            "content": "# CampusMarket Messaging System Documentation\r\n\r\n## Overview\r\nThe CampusMarket messaging system provides real-time chat functionality between customers and sellers. It enables customers to inquire about products and communicate directly with sellers.\r\n\r\n## Architecture\r\n\r\n### Collections\r\n- **chats**: Stores chat conversations between users\r\n  - `chatId`: Unique identifier for the chat\r\n  - `participants`: Array of user IDs participating in the chat\r\n  - `participantDetails`: Map of user information (name, role, profileImage)\r\n  - `lastMessage`: Most recent message text\r\n  - `lastMessageTime`: Timestamp of last message\r\n  - `lastMessageSenderId`: ID of user who sent last message\r\n  - `createdAt`: Chat creation timestamp\r\n\r\n- **messages** (subcollection under chats): Stores individual messages\r\n  - `messageId`: Unique identifier for the message\r\n  - `senderId`: ID of user who sent the message\r\n  - `text`: Message content\r\n  - `createdAt`: Message timestamp\r\n\r\n### Services\r\n\r\n#### ChatService (`src/app/services/chat.service.ts`)\r\nHandles all chat-related operations:\r\n\r\n**Key Methods:**\r\n- `createChat(user1Id, user2Id, user1Details, user2Details)`: Creates a new chat between two users\r\n- `getOrCreateChat(...)`: Gets existing chat or creates new one if doesn't exist\r\n- `getUserChats(userId)`: Retrieves all chats for a user (with 5s timeout)\r\n- `getChatMessages(chatId)`: Real-time observable of messages in a chat\r\n- `sendMessage(chatId, senderId, text)`: Sends a new message\r\n- `markChatAsRead(chatId, userId)`: Marks chat as read (future use)\r\n\r\n**Performance Features:**\r\n- 5-second timeout prevents infinite loading\r\n- 3-second fallback returns empty array if no chats found\r\n- Manual sorting instead of Firestore orderBy for speed\r\n- Real-time updates using Firestore snapshots\r\n\r\n## User Flows\r\n\r\n### Customer Initiates Chat\r\n1. Customer views product detail page\r\n2. Clicks \"Message Seller\" button\r\n3. System calls `ChatService.getOrCreateChat()`:\r\n   - Checks if chat exists between customer and seller\r\n   - If exists: Opens existing chat\r\n   - If new: Creates chat document with both participants\r\n4. Navigates to chat page (`/customer/chat/:chatId`)\r\n5. Customer can send/receive messages in real-time\r\n\r\n### Seller Receives Message\r\n1. Notification service sends notification to seller (in-app)\r\n2. Seller sees new message badge on Chats page\r\n3. Seller navigates to `/seller/chats`\r\n4. List shows all active conversations with customers\r\n5. Seller clicks chat to open conversation\r\n6. Messages load in real-time via Observable\r\n\r\n### Real-Time Synchronization\r\nThe messaging system uses Firestore real-time listeners:\r\n\r\n```typescript\r\n// Messages update in real-time\r\nthis.messages$ = this.chatService.getChatMessages(this.chatId);\r\n\r\n// Observable automatically updates when new messages arrive\r\nthis.messages$.subscribe(messages => {\r\n  this.messages = messages;\r\n  this.scrollToBottom();\r\n});\r\n```\r\n\r\n## UI Components\r\n\r\n### Customer Pages\r\n- **Chats List** (`customer/chats/chats.page.ts`)\r\n  - Displays all customer conversations\r\n  - Shows last message, seller name, timestamp\r\n  - Badge for unread messages (future)\r\n  - Auto-refreshes via Observable\r\n\r\n- **Chat Detail** (`customer/chat/chat.page.ts`)\r\n  - Message input field\r\n  - Message history (scrollable)\r\n  - Real-time message updates\r\n  - Auto-scroll to latest message\r\n\r\n### Seller Pages\r\n- **Chats List** (`seller/chats/chats.page.ts`)\r\n  - Similar to customer chats\r\n  - Shows customer names and last messages\r\n  - Quick access to all conversations\r\n\r\n- **Chat Detail** (`seller/chat/chat.page.ts`)\r\n  - Same interface as customer\r\n  - Sellers can respond to customer inquiries\r\n\r\n## Features\r\n\r\n### Implemented\r\n✅ Real-time messaging\r\n✅ Chat creation/retrieval\r\n✅ Message history\r\n✅ Participant details display\r\n✅ Auto-scroll to latest message\r\n✅ Loading states with timeout\r\n✅ Empty state handling\r\n✅ Profile images in chat list\r\n\r\n### Future Enhancements\r\n- ❌ Read receipts\r\n- ❌ Typing indicators\r\n- ❌ Image/file attachments\r\n- ❌ Message search\r\n- ❌ Push notifications\r\n- ❌ Chat deletion\r\n- ❌ Block user functionality\r\n\r\n## Error Handling\r\n\r\nThe system includes robust error handling:\r\n\r\n1. **Timeout Protection**: Chats load with 5-second timeout\r\n2. **Fallback Mechanism**: Returns empty array after 3 seconds if no data\r\n3. **Error Logging**: Console errors for debugging\r\n4. **Empty States**: User-friendly messages when no chats exist\r\n\r\n## Performance Optimizations\r\n\r\n1. **Lazy Loading**: Messages load only when chat is opened\r\n2. **Efficient Queries**: Uses whereIn for participant lookup\r\n3. **Manual Sorting**: Avoids slow Firestore orderBy queries\r\n4. **Timeout Mechanism**: Prevents indefinite loading states\r\n5. **Observable Pattern**: Real-time updates without polling\r\n\r\n## Code Examples\r\n\r\n### Creating a Chat\r\n```typescript\r\n// From product-detail.page.ts\r\nasync messageCreator() {\r\n  const user = this.authService.getCurrentUser();\r\n  if (user) {\r\n    const chatId = await this.chatService.getOrCreateChat(\r\n      user.userId!,\r\n      this.product.sellerId,\r\n      { name: user.name || user.email, role: user.role },\r\n      { name: this.product.sellerName, role: 'seller' }\r\n    );\r\n    this.router.navigate([`/customer/chat/${chatId}`]);\r\n  }\r\n}\r\n```\r\n\r\n### Sending a Message\r\n```typescript\r\nasync sendMessage() {\r\n  if (this.newMessage.trim() && this.currentUser) {\r\n    await this.chatService.sendMessage(\r\n      this.chatId,\r\n      this.currentUser.userId!,\r\n      this.newMessage.trim()\r\n    );\r\n    this.newMessage = '';\r\n  }\r\n}\r\n```\r\n\r\n### Loading Chats with Timeout\r\n```typescript\r\nasync loadChats() {\r\n  this.loading = true;\r\n  const timeoutId = setTimeout(() => {\r\n    this.loading = false;\r\n    console.error('Chat loading timeout');\r\n  }, 5000);\r\n\r\n  this.chatService.getUserChats(user.userId!).subscribe({\r\n    next: (chats) => {\r\n      clearTimeout(timeoutId);\r\n      this.chats = chats;\r\n      this.loading = false;\r\n    },\r\n    error: (error) => {\r\n      clearTimeout(timeoutId);\r\n      this.loading = false;\r\n    }\r\n  });\r\n}\r\n```\r\n\r\n## Database Structure\r\n\r\n```\r\nchats/\r\n  {chatId}/\r\n    chatId: string\r\n    participants: [userId1, userId2]\r\n    participantDetails: {\r\n      userId1: { name, role, profileImage },\r\n      userId2: { name, role, profileImage }\r\n    }\r\n    lastMessage: string\r\n    lastMessageTime: Timestamp\r\n    lastMessageSenderId: string\r\n    createdAt: Timestamp\r\n    \r\n    messages/ (subcollection)\r\n      {messageId}/\r\n        messageId: string\r\n        senderId: string\r\n        text: string\r\n        createdAt: Timestamp\r\n```\r\n\r\n## Security Rules (Recommended)\r\n\r\n```javascript\r\n// Firestore security rules for chats\r\nmatch /chats/{chatId} {\r\n  allow read, write: if request.auth.uid in resource.data.participants;\r\n  \r\n  match /messages/{messageId} {\r\n    allow read: if request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;\r\n    allow create: if request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;\r\n  }\r\n}\r\n```\r\n\r\n## Troubleshooting\r\n\r\n### Messages Not Loading\r\n- Check console for timeout errors\r\n- Verify chatId exists in Firestore\r\n- Ensure user is authenticated\r\n- Check internet connection\r\n\r\n### Chat List Empty\r\n- Wait for 3-second fallback\r\n- Verify chats collection has documents\r\n- Check participants array includes current userId\r\n- Look for console errors\r\n\r\n### Real-Time Not Working\r\n- Verify Firestore snapshot listeners are active\r\n- Check Observable subscription is not unsubscribed\r\n- Ensure component is not destroyed\r\n- Verify Firestore permissions\r\n\r\n## Contact\r\nFor issues or questions about the messaging system, check the console logs for detailed error messages.\r\n"
        }
    ]
}